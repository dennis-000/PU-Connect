{"version":3,"file":"useProducts-Bypg_9bL.js","sources":["../../src/hooks/useProducts.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { supabase } from '../lib/supabase';\nimport { useAuth } from '../contexts/AuthContext';\nimport type { Product } from '../lib/supabase';\n\nexport function useProducts(filters?: {\n  category?: string;\n  search?: string;\n  sellerId?: string;\n}) {\n  return useQuery({\n    queryKey: ['products', filters],\n    queryFn: async () => {\n      let query = supabase\n        .from('products')\n        .select(`\n          *,\n          seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url)\n        `)\n        .eq('is_active', true)\n        .order('created_at', { ascending: false })\n        .limit(100); // Add limit to prevent loading too much data\n\n      if (filters?.category && filters.category !== 'all') {\n        query = query.eq('category', filters.category);\n      }\n\n      if (filters?.search) {\n        query = query.or(`name.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);\n      }\n\n      if (filters?.sellerId) {\n        query = query.eq('seller_id', filters.sellerId);\n      }\n\n      const { data, error } = await query;\n\n      if (error) throw error;\n      return data || [];\n    },\n    staleTime: 1000 * 60 * 3, // 3 minutes\n    gcTime: 1000 * 60 * 10, // 10 minutes\n  });\n}\n\nexport function useProduct(id: string | undefined) {\n  return useQuery({\n    queryKey: ['product', id],\n    queryFn: async () => {\n      if (!id) return null;\n\n      const { data, error } = await supabase\n        .from('products')\n        .select(`\n          *,\n          seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url, student_id, department)\n        `)\n        .eq('id', id)\n        .single();\n\n      if (error) throw error;\n\n      // Increment view count asynchronously without waiting\n      Promise.resolve(supabase.rpc('increment_product_views', { product_id: id })).catch(console.error);\n\n      return data;\n    },\n    enabled: !!id,\n    staleTime: 1000 * 60 * 3, // 3 minutes\n    gcTime: 1000 * 60 * 10, // 10 minutes\n    retry: 3, // More retries for single product\n  });\n}\n\nexport function useCreateProduct() {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (product: Omit<Product, 'id' | 'seller_id' | 'created_at' | 'updated_at' | 'views_count'>) => {\n      if (!user) throw new Error('Not authenticated');\n\n      const { data, error } = await supabase\n        .from('products')\n        .insert({\n          ...product,\n          seller_id: user.id,\n        })\n        .select()\n        .single();\n\n      if (error) throw error;\n      return data;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['products'] });\n    },\n  });\n}\n\nexport function useUpdateProduct() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<Product> }) => {\n      const { data, error } = await supabase\n        .from('products')\n        .update(updates)\n        .eq('id', id)\n        .select()\n        .single();\n\n      if (error) throw error;\n      return data;\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['products'] });\n      queryClient.invalidateQueries({ queryKey: ['product', data.id] });\n    },\n  });\n}\n\nexport function useDeleteProduct() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const { error } = await supabase\n        .from('products')\n        .delete()\n        .eq('id', id);\n\n      if (error) throw error;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['products'] });\n    },\n  });\n}\n\nexport function useFavorites() {\n  const { user } = useAuth();\n\n  return useQuery({\n    queryKey: ['favorites', user?.id],\n    queryFn: async () => {\n      if (!user) return [];\n\n      const { data, error } = await supabase\n        .from('favorites')\n        .select(`\n          *,\n          product:products(\n            *,\n            seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url)\n          )\n        `)\n        .eq('user_id', user.id);\n\n      if (error) throw error;\n      return data || [];\n    },\n    enabled: !!user,\n    staleTime: 1000 * 60 * 10, // 10 minutes\n  });\n}\n\nexport function useToggleFavorite() {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (productId: string) => {\n      if (!user) throw new Error('Not authenticated');\n\n      // Check if already favorited\n      const { data: existing } = await supabase\n        .from('favorites')\n        .select('id')\n        .eq('user_id', user.id)\n        .eq('product_id', productId)\n        .single();\n\n      if (existing) {\n        // Remove favorite\n        const { error } = await supabase\n          .from('favorites')\n          .delete()\n          .eq('id', existing.id);\n\n        if (error) throw error;\n        return { action: 'removed' };\n      } else {\n        // Add favorite\n        const { error } = await supabase\n          .from('favorites')\n          .insert({\n            user_id: user.id,\n            product_id: productId,\n          });\n\n        if (error) throw error;\n        return { action: 'added' };\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['favorites'] });\n    },\n  });\n}\n"],"names":["useProducts","filters","useQuery","query","supabase","data","error"],"mappings":"uFAKO,SAASA,EAAYC,EAIzB,CACD,OAAOC,EAAS,CACd,SAAU,CAAC,WAAYD,CAAO,EAC9B,QAAS,SAAY,CACnB,IAAIE,EAAQC,EACT,KAAK,UAAU,EACf,OAAO;AAAA;AAAA;AAAA,SAGP,EACA,GAAG,YAAa,EAAI,EACpB,MAAM,aAAc,CAAE,UAAW,EAAA,CAAO,EACxC,MAAM,GAAG,EAcZ,KAAM,CAAE,KAAAC,EAAM,MAAAC,CAAA,EAAU,MAAMH,EAE9B,GAAIG,EAAO,MAAMA,EACjB,OAAOD,GAAQ,CAAA,CACjB,EACA,UAAW,IAAO,GAAK,EACvB,OAAQ,IAAO,GAAK,EAAA,CACrB,CACH"}