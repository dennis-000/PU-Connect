import{j as e}from"./query-vendor-C4XoQ8tj.js";import{r as n}from"./react-vendor-BpnWQj_L.js";import{u as U,s as c,N as F}from"./index-BvprY0-k.js";import"./i18n-vendor-BT3zpxCT.js";import"./supabase-vendor-NSJvwn9b.js";function z(){const{user:i}=U(),[j,v]=n.useState([]),[r,h]=n.useState(null),[f,N]=n.useState([]),[m,w]=n.useState(""),[E,_]=n.useState(!0),[g,S]=n.useState(!1),[C,x]=n.useState(null),[$,M]=n.useState(!0),O=n.useRef(null);n.useEffect(()=>{if(i){b();const s=setInterval(b,1e4);return()=>clearInterval(s)}},[i]),n.useEffect(()=>{r&&(I(r.id),L(r.id))},[r]),n.useEffect(()=>{q()},[f]);const q=()=>{O.current?.scrollIntoView({behavior:"smooth"})},A=s=>{h(s),M(!1)},D=()=>{M(!0),h(null)},b=async()=>{_(!0),x(null);try{const{data:s,error:t}=await c.from("conversations").select(`
          *,
          buyer:profiles!buyer_id(id, full_name, email, is_online, last_seen, avatar_url),
          seller:profiles!seller_id(id, full_name, email, is_online, last_seen, avatar_url),
          product:products(id, name)
        `).or(`buyer_id.eq.${i?.id},seller_id.eq.${i?.id}`).order("last_message_at",{ascending:!1});if(t)throw t;if(s){const l=s.map(a=>a.id);if(l.length>0){const{data:a}=await c.from("messages").select("conversation_id").in("conversation_id",l).eq("receiver_id",i?.id).eq("is_read",!1),u=a?.reduce((d,k)=>(d[k.conversation_id]=(d[k.conversation_id]||0)+1,d),{})||{},y=s.map(d=>({...d,unread_count:u[d.id]||0}));v(y),y.length>0&&!r&&h(y[0])}else v(s)}}catch(s){x("Failed to load conversations. Please try again."),console.error("Error fetching conversations:",s)}finally{_(!1)}},I=async s=>{try{const{data:t,error:l}=await c.from("messages").select("*").eq("conversation_id",s).order("created_at",{ascending:!0});if(l)throw l;t&&N(t)}catch(t){console.error("Error fetching messages:",t)}},L=async s=>{try{await c.from("messages").update({is_read:!0}).eq("conversation_id",s).eq("receiver_id",i?.id).eq("is_read",!1)}catch(t){console.error("Error marking messages as read:",t)}},T=async s=>{if(s.preventDefault(),!(!m.trim()||!r||!i)){S(!0),x(null);try{const t=r.buyer_id===i.id?r.seller_id:r.buyer_id,{data:l,error:a}=await c.from("messages").insert({conversation_id:r.id,sender_id:i.id,receiver_id:t,product_id:r.product_id,message:m.trim()}).select().single();if(a)throw a;if(l){N([...f,l]),w("");const{error:u}=await c.from("conversations").update({last_message:m.trim(),last_message_at:new Date().toISOString()}).eq("id",r.id);if(u)throw u;b()}}catch(t){x("Failed to send message. Please try again."),console.error("Error sending message:",t)}finally{S(!1)}}},o=s=>s.buyer_id===i?.id?s.seller:s.buyer,p=s=>{if(!s)return{isOnline:!1,text:"Offline"};if(s.is_online)return{isOnline:!0,text:"Online"};const t=new Date(s.last_seen),a=Math.floor((new Date().getTime()-t.getTime())/6e4);return a<5?{isOnline:!1,text:"Active recently"}:a<60?{isOnline:!1,text:`Active ${a}m ago`}:a<1440?{isOnline:!1,text:`Active ${Math.floor(a/60)}h ago`}:{isOnline:!1,text:`Active ${Math.floor(a/1440)}d ago`}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(F,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8 mt-16",children:[e.jsxs("div",{className:"mb-4 sm:mb-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2",children:"Messages"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600",children:"Chat with buyers and sellers"})]}),C&&e.jsx("div",{className:"mb-4 p-3 sm:p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:C}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",style:{height:"calc(100vh - 200px)"},children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 h-full",children:[e.jsx("div",{className:`${$?"block":"hidden"} lg:block lg:col-span-4 border-r border-gray-200 overflow-y-auto`,children:E?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"})}):j.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-6 text-center",children:[e.jsx("i",{className:"ri-message-3-line text-4xl sm:text-5xl text-gray-300 mb-4"}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 mb-2",children:"No conversations yet"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-600",children:"Start chatting with sellers or buyers"})]}):e.jsx("div",{children:j.map(s=>{const t=o(s),l=p(t),a=(s.unread_count||0)>0;return e.jsx("div",{onClick:()=>A(s),className:`p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer relative ${r?.id===s.id?"bg-blue-50 border-l-4 border-l-blue-600":""} ${a?"bg-blue-50/30":""}`,children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[t?.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.full_name,className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full object-cover border-2 border-blue-500"}):e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-yellow-400 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-xs sm:text-sm",children:t?.full_name?.charAt(0).toUpperCase()})}),l.isOnline&&e.jsx("div",{className:"absolute bottom-0 right-0 w-3 h-3 sm:w-3.5 sm:h-3.5 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:`text-xs sm:text-sm truncate ${a?"font-bold text-gray-900":"font-semibold text-gray-900"}`,children:t?.full_name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:new Date(s.last_message_at).toLocaleDateString()}),a&&e.jsx("span",{className:"w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center flex-shrink-0",children:s.unread_count>9?"9+":s.unread_count})]})]}),e.jsx("p",{className:"text-xs text-blue-600 mb-1",children:l.text}),s.product&&e.jsxs("p",{className:"text-xs text-gray-500 mb-1 truncate",children:["Re: ",s.product.name]}),e.jsx("p",{className:`text-xs sm:text-sm truncate ${a?"font-semibold text-gray-900":"text-gray-600"}`,children:s.last_message||"No messages yet"})]})]})},s.id)})})}),e.jsx("div",{className:`${$?"hidden":"block"} lg:block lg:col-span-8 flex flex-col`,children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-3 sm:p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-yellow-50",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:D,className:"lg:hidden p-2 hover:bg-white rounded-lg transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-arrow-left-line text-xl text-gray-700"})}),e.jsxs("div",{className:"relative",children:[o(r)?.avatar_url?e.jsx("img",{src:o(r)?.avatar_url,alt:o(r)?.full_name,className:"w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover border-2 border-blue-500"}):e.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-yellow-400 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-xs sm:text-sm",children:o(r)?.full_name?.charAt(0).toUpperCase()})}),p(o(r)).isOnline&&e.jsx("div",{className:"absolute bottom-0 right-0 w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 truncate",children:o(r)?.full_name}),e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:p(o(r)).text}),r.product&&e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5 truncate",children:["About: ",r.product.name]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4",children:[f.map(s=>{const t=s.sender_id===i?.id;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] sm:max-w-xs lg:max-w-md px-3 sm:px-4 py-2 rounded-2xl ${t?"bg-gradient-to-r from-blue-500 to-blue-600 text-white":"bg-gray-100 text-gray-900"}`,children:[e.jsx("p",{className:"text-xs sm:text-sm break-words",children:s.message}),e.jsx("p",{className:`text-xs mt-1 ${t?"text-blue-100":"text-gray-500"}`,children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id)}),e.jsx("div",{ref:O})]}),e.jsx("form",{onSubmit:T,className:"p-3 sm:p-4 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex space-x-2 sm:space-x-3",children:[e.jsx("input",{type:"text",value:m,onChange:s=>w(s.target.value),placeholder:"Type your message...",className:"flex-1 px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent text-xs sm:text-sm",disabled:g}),e.jsx("button",{type:"submit",disabled:g||!m.trim(),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:g?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin mr-2"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-send-plane-fill mr-2"}),"Send"]})})]})})]}):e.jsx("div",{className:"flex items-center justify-center h-full p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"ri-chat-3-line text-4xl sm:text-5xl text-gray-300 mb-4"}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-600",children:"Choose a conversation to start messaging"})]})})})]})})]})]})}export{z as default};
//# sourceMappingURL=Messages-BLYq4wLS.js.map
