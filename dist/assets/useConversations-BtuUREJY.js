import{a as _,u as w,b as f}from"./query-vendor-CC_3ftG1.js";import{u as y,s}from"./index-BpkOjQCb.js";function C(){const{user:e}=y(),{data:u=[],isLoading:n,refetch:l}=_({queryKey:["conversations",e?.id],queryFn:async()=>{if(!e)return[];const{data:i,error:o}=await s.from("conversations").select(`
          *,
          buyer:profiles!buyer_id(id, full_name, email, avatar_url, is_online, last_seen),
          seller:profiles!seller_id(id, full_name, email, avatar_url, is_online, last_seen),
          product:products(id, name)
        `).or(`buyer_id.eq.${e.id},seller_id.eq.${e.id}`).order("last_message_at",{ascending:!1});if(o)throw o;const t=i?.map(r=>r.id)||[],{data:a}=await s.from("messages").select("conversation_id").in("conversation_id",t).neq("sender_id",e.id).eq("is_read",!1),d=a?.reduce((r,m)=>(r[m.conversation_id]=(r[m.conversation_id]||0)+1,r),{})||{};return i?.map(r=>({...r,other_user:r.buyer_id===e.id?r.seller:r.buyer,unread_count:d[r.id]||0}))||[]},enabled:!!e,staleTime:1e3*60*10,refetchInterval:6e4}),{data:c=0}=_({queryKey:["unread-count",e?.id],queryFn:async()=>{if(!e)return 0;const{data:i}=await s.from("conversations").select("id").or(`buyer_id.eq.${e.id},seller_id.eq.${e.id}`);if(!i||i.length===0)return 0;const o=i.map(a=>a.id),{count:t}=await s.from("messages").select("*",{count:"exact",head:!0}).in("conversation_id",o).neq("sender_id",e.id).eq("is_read",!1);return t||0},enabled:!!e,staleTime:1e3*60*5,refetchInterval:6e4});return{conversations:u,isLoading:n,totalUnreadCount:c,refetch:l}}function Q(e){const{user:u}=y(),n=w(),{data:l=[],isLoading:c}=_({queryKey:["messages",e],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await s.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(a)throw a;return t||[]},enabled:!!e,staleTime:1e3*60*5,refetchInterval:1e4}),i=f({mutationFn:async({message:t,receiverId:a,file:d})=>{if(!e||!u)throw new Error("Missing required data");let r=null,m=null;if(d){const b=d.name.split(".").pop(),q=`${e}/${Date.now()}_${Math.random().toString(36).substring(7)}.${b}`,{error:h}=await s.storage.from("chat-attachments").upload(q,d);if(h)throw h;const{data:$}=s.storage.from("chat-attachments").getPublicUrl(q);r=$.publicUrl,d.type.startsWith("image/")?m="image":d.type.startsWith("video/")?m="video":m="file"}const{data:p,error:g}=await s.from("messages").insert({conversation_id:e,sender_id:u.id,receiver_id:a,message:t,attachment_url:r,attachment_type:m,is_read:!1}).select().single();if(g)throw g;const v=d?t?`ðŸ“· ${t}`:"Sent an attachment":t;return await s.from("conversations").update({last_message:v,last_message_at:new Date().toISOString()}).eq("id",e),p},onSuccess:()=>{n.invalidateQueries({queryKey:["messages",e]}),n.invalidateQueries({queryKey:["conversations"]})}}),o=f({mutationFn:async t=>{if(!u||t.length===0)return;const{error:a}=await s.from("messages").update({is_read:!0}).in("id",t).neq("sender_id",u.id);if(a)throw a},onSuccess:()=>{n.invalidateQueries({queryKey:["messages",e]}),n.invalidateQueries({queryKey:["conversations"]}),n.invalidateQueries({queryKey:["unread-count"]})}});return{messages:l,isLoading:c,sendMessage:i,markAsRead:o}}function D(){const{user:e}=y(),u=w();return f({mutationFn:async({otherUserId:n,productId:l})=>{if(!e)throw new Error("Not authenticated");let c=s.from("conversations").select("id").or(`and(buyer_id.eq.${e.id},seller_id.eq.${n}),and(buyer_id.eq.${n},seller_id.eq.${e.id})`);l&&(c=c.eq("product_id",l));const{data:i,error:o}=await c.maybeSingle();if(o)throw o;if(i)return i.id;const{data:t,error:a}=await s.from("conversations").insert({buyer_id:e.id,seller_id:n,product_id:l||null,last_message:"",last_message_at:new Date().toISOString()}).select("id").single();if(a)throw a;return t.id},onSuccess:()=>{u.invalidateQueries({queryKey:["conversations"]})}})}export{D as a,Q as b,C as u};
//# sourceMappingURL=useConversations-BtuUREJY.js.map
