{"version":3,"file":"useNews-ixPcrR5g.js","sources":["../../src/hooks/useNews.ts"],"sourcesContent":["import { useEffect } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuth } from '../contexts/AuthContext';\r\n\r\nexport type NewsArticle = {\r\n  id: string;\r\n  title: string;\r\n  content: string;\r\n  excerpt: string;\r\n  category: string;\r\n  image_url?: string;\r\n  author_id: string;\r\n  is_published: boolean;\r\n  published_at?: string;\r\n  views_count: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  author?: {\r\n    id: string;\r\n    full_name: string;\r\n    email: string;\r\n    avatar_url?: string;\r\n  };\r\n};\r\n\r\nexport function useNews(filters?: {\r\n  category?: string;\r\n  search?: string;\r\n  isPublished?: boolean;\r\n}) {\r\n  const queryClient = useQueryClient();\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    const channel = supabase\r\n      .channel('news-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'campus_news',\r\n        },\r\n        () => {\r\n          queryClient.invalidateQueries({ queryKey: ['news'] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [queryClient]);\r\n\r\n  return useQuery({\r\n    queryKey: ['news', filters],\r\n    queryFn: async () => {\r\n      try {\r\n        let query = supabase\r\n          .from('campus_news')\r\n          .select(`\r\n            *,\r\n            author:profiles(id, full_name, email, avatar_url)\r\n          `)\r\n          .order('created_at', { ascending: false });\r\n\r\n        if (filters?.isPublished !== undefined) {\r\n          query = query.eq('is_published', filters.isPublished);\r\n        } else {\r\n          query = query.eq('is_published', true);\r\n        }\r\n\r\n        if (filters?.category && filters.category !== 'all') {\r\n          query = query.eq('category', filters.category);\r\n        }\r\n\r\n        if (filters?.search) {\r\n          query = query.or(`title.ilike.%${filters.search}%,content.ilike.%${filters.search}%`);\r\n        }\r\n\r\n        const { data, error } = await query;\r\n\r\n        if (error) {\r\n          console.error('Supabase query error (news):', error);\r\n          throw error;\r\n        }\r\n        return data || [];\r\n      } catch (err) {\r\n        console.error('useNews error:', err);\r\n        throw err;\r\n      }\r\n    },\r\n    staleTime: 1000 * 60 * 5, // 5 minutes\r\n  });\r\n}\r\n\r\nexport function useFeaturedNews(limit: number = 5) {\r\n  return useQuery({\r\n    queryKey: ['news', 'featured', limit],\r\n    queryFn: async () => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('campus_news')\r\n          .select(`\r\n            *,\r\n            author:profiles(id, full_name, email, avatar_url)\r\n          `)\r\n          .eq('is_published', true)\r\n          .order('created_at', { ascending: false })\r\n          .limit(limit);\r\n\r\n        if (error) {\r\n          console.error('Featured news error:', error);\r\n          throw error;\r\n        }\r\n        return data || [];\r\n      } catch (err) {\r\n        console.error('useFeaturedNews error:', err);\r\n        throw err;\r\n      }\r\n    },\r\n    staleTime: 1000 * 60 * 10, // 10 minutes\r\n    gcTime: 1000 * 60 * 30, // 30 minutes\r\n    refetchOnWindowFocus: false,\r\n    refetchOnMount: false,\r\n    retry: 0,\r\n  });\r\n}\r\n\r\nexport function useNewsArticle(id: string | undefined) {\r\n  return useQuery({\r\n    queryKey: ['news', id],\r\n    queryFn: async () => {\r\n      if (!id) return null;\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('campus_news')\r\n          .select(`\r\n            *,\r\n            author:profiles(id, full_name, email, avatar_url)\r\n          `)\r\n          .eq('id', id)\r\n          .single();\r\n\r\n        if (error) {\r\n          console.error('News article fetch error:', error);\r\n          throw error;\r\n        }\r\n\r\n        // Increment view count - ignore if RPC fails\r\n        try {\r\n          await supabase.rpc('increment_news_views', { news_id: id });\r\n        } catch (rpcErr) {\r\n          console.warn('Failed to increment views:', rpcErr);\r\n        }\r\n\r\n        return data;\r\n      } catch (err) {\r\n        console.error('useNewsArticle error:', err);\r\n        throw err;\r\n      }\r\n    },\r\n    enabled: !!id,\r\n    staleTime: 1000 * 60 * 5, // 5 minutes\r\n  });\r\n}\r\n\r\nexport function useCreateNews() {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (article: Omit<NewsArticle, 'id' | 'author_id' | 'created_at' | 'updated_at' | 'views_count' | 'author'>) => {\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      const { data, error } = await supabase\r\n        .from('campus_news')\r\n        .insert({\r\n          ...article,\r\n          author_id: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['news'] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useUpdateNews() {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<NewsArticle> }) => {\r\n      const { data, error } = await supabase\r\n        .from('campus_news')\r\n        .update(updates)\r\n        .eq('id', id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: ['news'] });\r\n      queryClient.invalidateQueries({ queryKey: ['news', data.id] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useDeleteNews() {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (id: string) => {\r\n      const { error } = await supabase\r\n        .from('campus_news')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['news'] });\r\n    },\r\n  });\r\n}\r\n"],"names":["useNews","filters","queryClient","useQueryClient","useEffect","channel","supabase","useQuery","query","data","error","err","useFeaturedNews","limit","useNewsArticle","id","rpcErr"],"mappings":"mIA0BO,SAASA,EAAQC,EAIrB,CACD,MAAMC,EAAcC,EAAA,EAGpBC,OAAAA,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAUC,EACb,QAAQ,cAAc,EACtB,GACC,mBACA,CACE,MAAO,IACP,OAAQ,SACR,MAAO,aAAA,EAET,IAAM,CACJJ,EAAY,kBAAkB,CAAE,SAAU,CAAC,MAAM,EAAG,CACtD,CAAA,EAED,UAAA,EAEH,MAAO,IAAM,CACXI,EAAS,cAAcD,CAAO,CAChC,CACF,EAAG,CAACH,CAAW,CAAC,EAETK,EAAS,CACd,SAAU,CAAC,OAAQN,CAAO,EAC1B,QAAS,SAAY,CACnB,GAAI,CACF,IAAIO,EAAQF,EACT,KAAK,aAAa,EAClB,OAAO;AAAA;AAAA;AAAA,WAGP,EACA,MAAM,aAAc,CAAE,UAAW,GAAO,EAEvCL,GAAS,cAAgB,OAC3BO,EAAQA,EAAM,GAAG,eAAgBP,EAAQ,WAAW,EAEpDO,EAAQA,EAAM,GAAG,eAAgB,EAAI,EAGnCP,GAAS,UAAYA,EAAQ,WAAa,QAC5CO,EAAQA,EAAM,GAAG,WAAYP,EAAQ,QAAQ,GAG3CA,GAAS,SACXO,EAAQA,EAAM,GAAG,gBAAgBP,EAAQ,MAAM,oBAAoBA,EAAQ,MAAM,GAAG,GAGtF,KAAM,CAAE,KAAAQ,EAAM,MAAAC,CAAA,EAAU,MAAMF,EAE9B,GAAIE,EACF,cAAQ,MAAM,+BAAgCA,CAAK,EAC7CA,EAER,OAAOD,GAAQ,CAAA,CACjB,OAASE,EAAK,CACZ,cAAQ,MAAM,iBAAkBA,CAAG,EAC7BA,CACR,CACF,EACA,UAAW,IAAO,GAAK,CAAA,CACxB,CACH,CAEO,SAASC,EAAgBC,EAAgB,EAAG,CACjD,OAAON,EAAS,CACd,SAAU,CAAC,OAAQ,WAAYM,CAAK,EACpC,QAAS,SAAY,CACnB,GAAI,CACF,KAAM,CAAE,KAAAJ,EAAM,MAAAC,GAAU,MAAMJ,EAC3B,KAAK,aAAa,EAClB,OAAO;AAAA;AAAA;AAAA,WAGP,EACA,GAAG,eAAgB,EAAI,EACvB,MAAM,aAAc,CAAE,UAAW,EAAA,CAAO,EACxC,MAAMO,CAAK,EAEd,GAAIH,EACF,cAAQ,MAAM,uBAAwBA,CAAK,EACrCA,EAER,OAAOD,GAAQ,CAAA,CACjB,OAASE,EAAK,CACZ,cAAQ,MAAM,yBAA0BA,CAAG,EACrCA,CACR,CACF,EACA,UAAW,IAAO,GAAK,GACvB,OAAQ,IAAO,GAAK,GACpB,qBAAsB,GACtB,eAAgB,GAChB,MAAO,CAAA,CACR,CACH,CAEO,SAASG,EAAeC,EAAwB,CACrD,OAAOR,EAAS,CACd,SAAU,CAAC,OAAQQ,CAAE,EACrB,QAAS,SAAY,CACnB,GAAI,CAACA,EAAI,OAAO,KAEhB,GAAI,CACF,KAAM,CAAE,KAAAN,EAAM,MAAAC,GAAU,MAAMJ,EAC3B,KAAK,aAAa,EAClB,OAAO;AAAA;AAAA;AAAA,WAGP,EACA,GAAG,KAAMS,CAAE,EACX,OAAA,EAEH,GAAIL,EACF,cAAQ,MAAM,4BAA6BA,CAAK,EAC1CA,EAIR,GAAI,CACF,MAAMJ,EAAS,IAAI,uBAAwB,CAAE,QAASS,EAAI,CAC5D,OAASC,EAAQ,CACf,QAAQ,KAAK,6BAA8BA,CAAM,CACnD,CAEA,OAAOP,CACT,OAASE,EAAK,CACZ,cAAQ,MAAM,wBAAyBA,CAAG,EACpCA,CACR,CACF,EACA,QAAS,CAAC,CAACI,EACX,UAAW,IAAO,GAAK,CAAA,CACxB,CACH"}