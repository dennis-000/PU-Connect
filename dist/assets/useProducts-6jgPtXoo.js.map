{"version":3,"file":"useProducts-6jgPtXoo.js","sources":["../../src/hooks/useProducts.ts"],"sourcesContent":["import { useEffect } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport type { Product } from '../lib/supabase';\r\n\r\nexport function useProducts(filters?: {\r\n  category?: string;\r\n  search?: string;\r\n  sellerId?: string;\r\n}) {\r\n  const queryClient = useQueryClient();\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    const channel = supabase\r\n      .channel('products-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'products',\r\n        },\r\n        () => {\r\n          queryClient.invalidateQueries({ queryKey: ['products'] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [queryClient]);\r\n\r\n  return useQuery({\r\n    queryKey: ['products', filters],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from('products')\r\n        .select(`\r\n          *,\r\n          seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url)\r\n        `)\r\n        .eq('is_active', true)\r\n        .order('created_at', { ascending: false })\r\n        .limit(100); // Add limit to prevent loading too much data\r\n\r\n      if (filters?.category && filters.category !== 'all') {\r\n        query = query.eq('category', filters.category);\r\n      }\r\n\r\n      if (filters?.search) {\r\n        query = query.or(`name.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);\r\n      }\r\n\r\n      if (filters?.sellerId) {\r\n        query = query.eq('seller_id', filters.sellerId);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    },\r\n    staleTime: 1000 * 60 * 3, // 3 minutes\r\n    gcTime: 1000 * 60 * 10, // 10 minutes\r\n  });\r\n}\r\n\r\nexport function useProduct(id: string | undefined) {\r\n  return useQuery({\r\n    queryKey: ['product', id],\r\n    queryFn: async () => {\r\n      if (!id) return null;\r\n\r\n      const { data, error } = await supabase\r\n        .from('products')\r\n        .select(`\r\n          *,\r\n          seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url, student_id, department)\r\n        `)\r\n        .eq('id', id)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Increment view count asynchronously without waiting\r\n      Promise.resolve(supabase.rpc('increment_product_views', { product_id: id })).catch(console.error);\r\n\r\n      return data;\r\n    },\r\n    enabled: !!id,\r\n    staleTime: 1000 * 60 * 3, // 3 minutes\r\n    gcTime: 1000 * 60 * 10, // 10 minutes\r\n    retry: 3, // More retries for single product\r\n  });\r\n}\r\n\r\nexport function useCreateProduct() {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (product: Omit<Product, 'id' | 'seller_id' | 'created_at' | 'updated_at' | 'views_count'>) => {\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      const { data, error } = await supabase\r\n        .from('products')\r\n        .insert({\r\n          ...product,\r\n          seller_id: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['products'] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useUpdateProduct() {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<Product> }) => {\r\n      const { data, error } = await supabase\r\n        .from('products')\r\n        .update(updates)\r\n        .eq('id', id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: ['products'] });\r\n      queryClient.invalidateQueries({ queryKey: ['product', data.id] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useDeleteProduct() {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (id: string) => {\r\n      const { error } = await supabase\r\n        .from('products')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['products'] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useFavorites() {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: ['favorites', user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from('favorites')\r\n        .select(`\r\n          *,\r\n          product:products(\r\n            *,\r\n            seller:profiles!products_seller_id_fkey(id, full_name, email, avatar_url)\r\n          )\r\n        `)\r\n        .eq('user_id', user.id);\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    },\r\n    enabled: !!user,\r\n    staleTime: 1000 * 60 * 10, // 10 minutes\r\n  });\r\n}\r\n\r\nexport function useToggleFavorite() {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (productId: string) => {\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      // Check if already favorited\r\n      const { data: existing } = await supabase\r\n        .from('favorites')\r\n        .select('id')\r\n        .eq('user_id', user.id)\r\n        .eq('product_id', productId)\r\n        .single();\r\n\r\n      if (existing) {\r\n        // Remove favorite\r\n        const { error } = await supabase\r\n          .from('favorites')\r\n          .delete()\r\n          .eq('id', existing.id);\r\n\r\n        if (error) throw error;\r\n        return { action: 'removed' };\r\n      } else {\r\n        // Add favorite\r\n        const { error } = await supabase\r\n          .from('favorites')\r\n          .insert({\r\n            user_id: user.id,\r\n            product_id: productId,\r\n          });\r\n\r\n        if (error) throw error;\r\n        return { action: 'added' };\r\n      }\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['favorites'] });\r\n    },\r\n  });\r\n}\r\n"],"names":["useProducts","filters","queryClient","useQueryClient","useEffect","channel","supabase","useQuery","query","data","error","useProduct","id","useUpdateProduct","useMutation","updates","useDeleteProduct","useFavorites","user","useAuth","useToggleFavorite","productId","existing"],"mappings":"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"}