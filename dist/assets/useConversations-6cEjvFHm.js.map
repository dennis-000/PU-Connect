{"version":3,"file":"useConversations-6cEjvFHm.js","sources":["../../src/hooks/useConversations.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuth } from '../contexts/AuthContext';\r\n\r\nexport type Message = {\r\n  id: string;\r\n  conversation_id: string;\r\n  sender_id: string;\r\n  receiver_id: string;\r\n  message: string;\r\n  attachment_url?: string;\r\n  attachment_type?: 'image' | 'video' | 'file';\r\n  is_read: boolean;\r\n  created_at: string;\r\n};\r\n\r\nexport type Conversation = {\r\n  id: string;\r\n  buyer_id: string;\r\n  seller_id: string;\r\n  product_id: string | null;\r\n  last_message: string;\r\n  last_message_at: string;\r\n  created_at: string;\r\n  updated_at?: string;\r\n  other_user?: {\r\n    id: string;\r\n    full_name: string;\r\n    email: string;\r\n    avatar_url?: string;\r\n    is_online?: boolean;\r\n    last_seen?: string;\r\n  };\r\n  product?: {\r\n    id: string;\r\n    name: string;\r\n  };\r\n  unread_count?: number;\r\n};\r\n\r\nexport function useConversations() {\r\n  const { user } = useAuth();\r\n\r\n  const { data: conversations = [], isLoading, refetch } = useQuery({\r\n    queryKey: ['conversations', user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .select(`\r\n          *,\r\n          buyer:profiles!buyer_id(id, full_name, email, avatar_url, is_online, last_seen),\r\n          seller:profiles!seller_id(id, full_name, email, avatar_url, is_online, last_seen),\r\n          product:products(id, name)\r\n        `)\r\n        .or(`buyer_id.eq.${user.id},seller_id.eq.${user.id}`)\r\n        .order('last_message_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      // Get unread counts for all conversations in one query\r\n      const conversationIds = data?.map(c => c.id) || [];\r\n      const { data: unreadData } = await supabase\r\n        .from('messages')\r\n        .select('conversation_id')\r\n        .in('conversation_id', conversationIds)\r\n        .neq('sender_id', user.id)\r\n        .eq('is_read', false);\r\n\r\n      const unreadCounts = unreadData?.reduce((acc, msg) => {\r\n        acc[msg.conversation_id] = (acc[msg.conversation_id] || 0) + 1;\r\n        return acc;\r\n      }, {} as Record<string, number>) || {};\r\n\r\n      return data?.map((conv: any) => ({\r\n        ...conv,\r\n        other_user: conv.buyer_id === user.id ? conv.seller : conv.buyer,\r\n        unread_count: unreadCounts[conv.id] || 0,\r\n      })) || [];\r\n    },\r\n    enabled: !!user,\r\n    staleTime: 1000 * 60 * 10, // 10 minutes\r\n    refetchInterval: 60000, // Refetch every 60 seconds\r\n  });\r\n\r\n  const { data: totalUnreadCount = 0 } = useQuery({\r\n    queryKey: ['unread-count', user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return 0;\r\n\r\n      const { data: convData } = await supabase\r\n        .from('conversations')\r\n        .select('id')\r\n        .or(`buyer_id.eq.${user.id},seller_id.eq.${user.id}`);\r\n\r\n      if (!convData || convData.length === 0) return 0;\r\n\r\n      const conversationIds = convData.map(c => c.id);\r\n\r\n      const { count } = await supabase\r\n        .from('messages')\r\n        .select('*', { count: 'exact', head: true })\r\n        .in('conversation_id', conversationIds)\r\n        .neq('sender_id', user.id)\r\n        .eq('is_read', false);\r\n\r\n      return count || 0;\r\n    },\r\n    enabled: !!user,\r\n    staleTime: 1000 * 60 * 5, // 5 minutes\r\n    refetchInterval: 60000, // Refetch every 60 seconds\r\n  });\r\n\r\n  return {\r\n    conversations,\r\n    isLoading,\r\n    totalUnreadCount,\r\n    refetch,\r\n  };\r\n}\r\n\r\nexport function useMessages(conversationId: string | null) {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  const { data: messages = [], isLoading } = useQuery({\r\n    queryKey: ['messages', conversationId],\r\n    queryFn: async () => {\r\n      if (!conversationId) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from('messages')\r\n        .select('*')\r\n        .eq('conversation_id', conversationId)\r\n        .order('created_at', { ascending: true });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    },\r\n    enabled: !!conversationId,\r\n    staleTime: 1000 * 60 * 5, // 5 minutes\r\n    refetchInterval: 10000, // Refetch every 10 seconds\r\n  });\r\n\r\n  const sendMessage = useMutation({\r\n    mutationFn: async ({ message, receiverId, file }: { message: string, receiverId: string, file?: File }) => {\r\n      if (!conversationId || !user) throw new Error('Missing required data');\r\n\r\n      let attachmentUrl = null;\r\n      let attachmentType = null;\r\n\r\n      if (file) {\r\n        // Upload file to Supabase Storage\r\n        const fileExt = file.name.split('.').pop();\r\n        const fileName = `${conversationId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n          .from('chat-attachments')\r\n          .upload(fileName, file);\r\n\r\n        if (uploadError) throw uploadError;\r\n\r\n        const { data: publicUrlData } = supabase.storage\r\n          .from('chat-attachments')\r\n          .getPublicUrl(fileName);\r\n\r\n        attachmentUrl = publicUrlData.publicUrl;\r\n\r\n        // Determine attachment type\r\n        if (file.type.startsWith('image/')) attachmentType = 'image';\r\n        else if (file.type.startsWith('video/')) attachmentType = 'video';\r\n        else attachmentType = 'file';\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('messages')\r\n        .insert({\r\n          conversation_id: conversationId,\r\n          sender_id: user.id,\r\n          receiver_id: receiverId,\r\n          message,\r\n          attachment_url: attachmentUrl,\r\n          attachment_type: attachmentType,\r\n          is_read: false,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Update conversation's last message with preview text\r\n      const lastMessageText = file ? (message ? `ðŸ“· ${message}` : 'Sent an attachment') : message;\r\n\r\n      await supabase\r\n        .from('conversations')\r\n        .update({\r\n          last_message: lastMessageText,\r\n          last_message_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', conversationId);\r\n\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['messages', conversationId] });\r\n      queryClient.invalidateQueries({ queryKey: ['conversations'] });\r\n    },\r\n  });\r\n\r\n  const markAsRead = useMutation({\r\n    mutationFn: async (messageIds: string[]) => {\r\n      if (!user || messageIds.length === 0) return;\r\n\r\n      const { error } = await supabase\r\n        .from('messages')\r\n        .update({ is_read: true })\r\n        .in('id', messageIds)\r\n        .neq('sender_id', user.id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['messages', conversationId] });\r\n      queryClient.invalidateQueries({ queryKey: ['conversations'] });\r\n      queryClient.invalidateQueries({ queryKey: ['unread-count'] });\r\n    },\r\n  });\r\n\r\n  return {\r\n    messages,\r\n    isLoading,\r\n    sendMessage,\r\n    markAsRead,\r\n  };\r\n}\r\n\r\nexport function useCreateConversation() {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ otherUserId, productId }: { otherUserId: string, productId?: string }) => {\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      // Check if conversation already exists\r\n      let query = supabase\r\n        .from('conversations')\r\n        .select('id')\r\n        .or(`and(buyer_id.eq.${user.id},seller_id.eq.${otherUserId}),and(buyer_id.eq.${otherUserId},seller_id.eq.${user.id})`);\r\n\r\n      if (productId) {\r\n        query = query.eq('product_id', productId);\r\n      }\r\n\r\n      const { data: existing, error: fetchError } = await query.maybeSingle();\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      if (existing) return existing.id;\r\n\r\n      // Create new conversation\r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .insert({\r\n          buyer_id: user.id,\r\n          seller_id: otherUserId,\r\n          product_id: productId || null,\r\n          last_message: '',\r\n          last_message_at: new Date().toISOString(),\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data.id;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['conversations'] });\r\n    },\r\n  });\r\n}\r\n\r\n"],"names":["useConversations","user","useAuth","conversations","isLoading","refetch","useQuery","data","error","supabase","conversationIds","c","unreadData","unreadCounts","acc","msg","conv","totalUnreadCount","convData","count","useMessages","conversationId","queryClient","useQueryClient","messages","sendMessage","useMutation","message","receiverId","file","attachmentUrl","attachmentType","fileExt","fileName","uploadError","publicUrlData","lastMessageText","markAsRead","messageIds","useCreateConversation","otherUserId","productId","query","existing","fetchError"],"mappings":"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"}