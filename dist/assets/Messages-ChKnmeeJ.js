import{j as e}from"./query-vendor-CC_3ftG1.js";import{r as l,f as K}from"./react-vendor-Bsfkyusf.js";import{u as Q,s as j,N as X,g as k}from"./index-CcOhh2SE.js";import{u as Y,b as Z}from"./useConversations-g8fwN2cl.js";import{logActivity as ee}from"./logger-F06xvXqL.js";import"./i18n-vendor-CQdsz7qV.js";import"./supabase-vendor-C3liu3n-.js";function de(){const{user:n}=Q(),{conversations:o,isLoading:F,totalUnreadCount:N,refetch:E}=Y(),[r,b]=l.useState(null),{messages:m,isLoading:L,sendMessage:f,markAsRead:_}=Z(r?.id||null),[h,S]=l.useState(""),[c,C]=l.useState(null),[M,O]=l.useState(!0),[u,x]=l.useState(!1),[w,R]=l.useState(""),[$,z]=l.useState([]),[P,A]=l.useState(!1),D=l.useRef(null),p=l.useRef(null),[T,U]=l.useState(new Set);l.useEffect(()=>{const t=j.channel("online-users").on("presence",{event:"sync"},()=>{const s=t.presenceState(),a=new Set;for(const i in s)s[i].forEach(d=>{d.user_id&&a.add(d.user_id)});U(a)}).subscribe();return()=>{j.removeChannel(t)}},[]);const[B]=K(),y=B.get("conversationId");l.useEffect(()=>{if(y&&o.length>0){const t=o.find(s=>s.id===y);t&&b(t)}else o.length>0&&!r&&!u&&!y&&window.innerWidth>=1024&&b(o[0])},[o,r,y,u]),l.useEffect(()=>{if(r&&m.length>0){const t=m.filter(s=>!s.is_read&&s.sender_id!==n?.id).map(s=>s.id);t.length>0&&_.mutate(t)}},[r,m,n?.id,_]),l.useEffect(()=>{q()},[m]);const q=()=>{D.current?.scrollIntoView({behavior:"smooth"})},v=t=>{b(t),O(!1)},W=()=>{O(!0),b(null)},H=t=>{if(t.target.files&&t.target.files[0]){const s=t.target.files[0];if(s.size>5*1024*1024){alert("File size too large. Please select a file under 5MB.");return}C(s)}},I=()=>{C(null),p.current&&(p.current.value="")},V=async t=>{if(t.preventDefault(),!h.trim()&&!c||!r||!n)return;const s=r.buyer_id===n.id?r.seller_id:r.buyer_id;f.mutate({message:h.trim(),receiverId:s,file:c||void 0},{onSuccess:async()=>{try{await ee(n.id,"message_sent",{receiver_id:s,content_snippet:h.trim().slice(0,100),has_attachment:!!c})}catch(a){console.error("Failed to log message activity",a)}S(""),I()}})},g=(t,s)=>{if(T.has(t))return{isOnline:!0,text:"Online"};if(!s)return{isOnline:!1,text:"Offline"};const a=new Date(s),d=Math.floor((new Date().getTime()-a.getTime())/6e4);return d<5?{isOnline:!1,text:"Active recently"}:d<60?{isOnline:!1,text:`Active ${d}m ago`}:d<1440?{isOnline:!1,text:`Active ${Math.floor(d/60)}h ago`}:{isOnline:!1,text:`Active ${Math.floor(d/1440)}d ago`}},G=async t=>{A(!0);try{let s=j.from("profiles").select("id, full_name, avatar_url, role, last_seen").neq("id",n?.id).limit(20);t&&(s=s.ilike("full_name",`%${t}%`));const{data:a,error:i}=await s;if(i)throw i;z(a||[])}catch(s){console.error("Error searching users",s)}finally{A(!1)}};l.useEffect(()=>{u&&G(w)},[u,w]);const J=async t=>{if(!n)return;const s=o.find(a=>a.buyer_id===n.id&&a.seller_id===t.id||a.seller_id===n.id&&a.buyer_id===t.id);if(s){v(s),x(!1);return}try{const{data:a,error:i}=await j.from("conversations").insert({buyer_id:n.id,seller_id:t.id,last_message:"",last_message_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(i)throw i;await E();const d={id:a.id,product_id:null,buyer_id:n.id,seller_id:t.id,created_at:a.created_at,updated_at:a.updated_at,product:void 0,other_user:t,last_message:"",last_message_at:new Date().toISOString(),unread_count:0};v(d),x(!1)}catch(a){console.error("Failed to start chat",a),alert("Could not start chat. Please try again.")}};return e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-slate-900 transition-colors duration-300 pb-20",children:[e.jsx(X,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8 mt-16 pt-24",children:[e.jsxs("div",{className:"mb-4 sm:mb-6 flex justify-between items-end",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white tracking-tight mb-1",children:"Messages"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 font-medium",children:"Connect with the campus community"})]}),e.jsxs("div",{className:"flex gap-2",children:[N>0&&e.jsxs("span",{className:"bg-blue-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-blue-500/20 flex items-center h-10",children:[N," New"]}),e.jsxs("button",{onClick:()=>x(!0),className:"bg-gray-900 dark:bg-white dark:text-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-black dark:hover:bg-gray-200 transition-all flex items-center gap-2 h-10",children:[e.jsx("i",{className:"ri-edit-box-line text-lg"}),e.jsx("span",{className:"hidden sm:inline",children:"New Chat"})]})]})]}),e.jsx("div",{className:"bg-white dark:bg-slate-800 rounded-[2rem] border border-gray-100 dark:border-slate-700 shadow-xl shadow-gray-200/40 dark:shadow-none overflow-hidden h-[calc(100dvh-11rem)] md:h-[calc(100dvh-13rem)]",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 h-full",children:[e.jsx("div",{className:`${M?"block":"hidden"} lg:block lg:col-span-4 border-r border-gray-50 dark:border-slate-700 overflow-y-auto bg-gray-50/30 dark:bg-slate-900/30`,children:F?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"w-8 h-8 border-4 border-gray-100 dark:border-slate-700 border-t-blue-600 rounded-full animate-spin"})}):o.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 dark:bg-slate-700 rounded-2xl flex items-center justify-center mb-6",children:e.jsx("i",{className:"ri-message-3-line text-3xl text-gray-300 dark:text-gray-500"})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white mb-2 tracking-tight",children:"No conversations yet"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 font-medium mb-4",children:"Start chatting with students and sellers on the platform."}),e.jsx("button",{onClick:()=>x(!0),className:"text-blue-600 dark:text-blue-400 text-xs font-bold uppercase tracking-widest hover:underline",children:"Start a New Chat"})]}):e.jsx("div",{className:"divide-y divide-gray-50 dark:divide-slate-700",children:o.map(t=>{const s=t.other_user;if(!s)return null;const a=g(s.id,s.last_seen),i=(t.unread_count||0)>0;return e.jsx("div",{onClick:()=>v(t),className:`p-5 transition-all cursor-pointer relative ${r?.id===t.id?"bg-white dark:bg-slate-800 shadow-md border-r-4 border-r-blue-600 z-10 scale-[1.02]":"hover:bg-white dark:hover:bg-slate-800"} ${i?"bg-blue-50/20 dark:bg-blue-900/10":""}`,children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[s?.avatar_url?e.jsx("img",{src:k(s.avatar_url,100,80),alt:s.full_name,className:"w-12 h-12 rounded-2xl object-cover border border-gray-100 dark:border-slate-600",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"w-12 h-12 bg-gray-900 dark:bg-slate-700 rounded-2xl flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-sm",children:s?.full_name?.charAt(0).toUpperCase()})}),a.isOnline&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:`text-sm truncate tracking-tight ${i?"font-bold text-gray-900 dark:text-white":"font-semibold text-gray-900 dark:text-white"}`,children:s?.full_name}),e.jsx("span",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-widest whitespace-nowrap ml-2",children:new Date(t.last_message_at).toLocaleDateString([],{month:"short",day:"numeric"})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:`text-xs truncate flex-1 font-medium ${i?"text-gray-900 dark:text-gray-200 font-bold":"text-gray-500 dark:text-gray-400"}`,children:t.last_message||"Draft message..."}),i&&e.jsx("span",{className:"ml-2 w-5 h-5 bg-blue-600 text-white text-[10px] font-bold rounded-lg flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/10",children:t.unread_count})]}),t.product&&e.jsxs("p",{className:"text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-widest mt-2 truncate",children:["Re: ",t.product.name]})]})]})},t.id)})})}),e.jsx("div",{className:`${M?"hidden":"block"} lg:block lg:col-span-8 flex flex-col bg-white dark:bg-slate-800`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-50 dark:border-slate-700 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:W,className:"lg:hidden w-10 h-10 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl transition-all cursor-pointer",children:e.jsx("i",{className:"ri-arrow-left-line text-xl text-gray-700 dark:text-gray-300"})}),e.jsxs("div",{className:"relative",children:[r.other_user?.avatar_url?e.jsx("img",{src:k(r.other_user.avatar_url,120,80),alt:r.other_user.full_name,className:"w-10 h-10 sm:w-12 sm:h-12 rounded-2xl object-cover border border-gray-100 dark:border-slate-600 shadow-sm",loading:"eager",decoding:"async"}):e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-gray-900 dark:bg-slate-700 rounded-2xl shadow-sm flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-base",children:r.other_user?.full_name?.charAt(0).toUpperCase()})}),g(r.other_user?.id||"",r.other_user?.last_seen).isOnline&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-gray-900 dark:text-white truncate tracking-tight",children:r.other_user?.full_name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${g(r.other_user?.id||"",r.other_user?.last_seen).isOnline?"bg-emerald-500":"bg-gray-300 dark:bg-gray-600"}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-widest",children:g(r.other_user?.id||"",r.other_user?.last_seen).text})]})]})]}),r.product&&e.jsxs("div",{className:"hidden sm:block text-right",children:[e.jsx("p",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1",children:"Inquiry Topic"}),e.jsx("p",{className:"text-sm font-bold text-blue-600 dark:text-blue-400 truncate max-w-[150px]",children:r.product.name})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-8 space-y-6 sm:space-y-8 bg-gray-50/50 dark:bg-slate-900/50",children:[L?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"w-8 h-8 border-4 border-gray-100 dark:border-slate-700 border-t-blue-600 rounded-full animate-spin"})}):m.map(t=>{const s=t.sender_id===n?.id;return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] sm:max-w-md px-5 py-3 rounded-[1.5rem] shadow-sm ${s?"bg-blue-600 text-white rounded-tr-none":"bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-tl-none border border-gray-100 dark:border-slate-600"}`,children:[t.attachment_url&&e.jsx("div",{className:"mb-3",children:t.attachment_type==="image"?e.jsx("a",{href:t.attachment_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:t.attachment_url,alt:"Attachment",className:"rounded-xl max-w-full max-h-[200px] object-cover border border-white/10",loading:"lazy"})}):e.jsxs("a",{href:t.attachment_url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-3 p-3 rounded-xl ${s?"bg-white/10":"bg-gray-100 dark:bg-slate-600"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${s?"bg-white/20":"bg-white dark:bg-slate-500"}`,children:e.jsx("i",{className:"ri-file-text-line text-xl"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-bold truncate",children:"Attachment"}),e.jsx("p",{className:"text-[10px] opacity-70 uppercase",children:"Click to view"})]}),e.jsx("i",{className:"ri-external-link-line"})]})}),t.message&&e.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:t.message}),e.jsxs("div",{className:`flex items-center justify-end mt-2 space-x-1 ${s?"text-blue-200":"text-gray-400"}`,children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-widest",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s&&e.jsx("i",{className:`ri-check-double-line ${t.is_read?"text-blue-200":"text-blue-300"}`})]})]})},t.id)}),e.jsx("div",{ref:D})]}),e.jsxs("div",{className:"p-4 sm:p-6 bg-white dark:bg-slate-800 border-t border-gray-50 dark:border-slate-700",children:[c&&e.jsxs("div",{className:"mb-4 flex items-center gap-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-2xl border border-gray-100 dark:border-slate-600 animate-fade-in-up",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-white dark:bg-slate-600 border border-gray-200 dark:border-slate-500 flex items-center justify-center overflow-hidden",children:c.type.startsWith("image/")?e.jsx("img",{src:URL.createObjectURL(c),alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("i",{className:"ri-file-text-line text-2xl text-gray-400 dark:text-gray-300"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-bold text-gray-900 dark:text-white truncate",children:c.name}),e.jsxs("p",{className:"text-[10px] text-gray-500 dark:text-gray-400 font-medium",children:[(c.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx("button",{onClick:I,className:"w-8 h-8 rounded-full bg-gray-200 dark:bg-slate-600 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-colors",children:e.jsx("i",{className:"ri-close-line"})})]}),e.jsxs("form",{onSubmit:V,className:"relative flex items-end gap-3",children:[e.jsx("input",{type:"file",ref:p,onChange:H,className:"hidden",accept:"image/*,.pdf,.doc,.docx"}),e.jsx("button",{type:"button",onClick:()=>p.current?.click(),className:"w-12 h-14 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 text-gray-500 dark:text-gray-300 hover:text-blue-600 rounded-2xl flex items-center justify-center transition-colors border border-transparent hover:border-gray-200 dark:hover:border-slate-500 flex-shrink-0",title:"Attach file",children:e.jsx("i",{className:"ri-attachment-2 text-xl"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",value:h,onChange:t=>S(t.target.value),placeholder:"Compose your message...",className:"w-full pl-6 pr-32 py-4 bg-gray-50 dark:bg-slate-700 border-none rounded-2xl focus:ring-2 focus:ring-blue-600 dark:text-white text-sm font-medium transition-all",disabled:f.isPending}),e.jsx("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center space-x-2",children:e.jsxs("button",{type:"submit",disabled:f.isPending||!h.trim()&&!c,className:"px-6 py-2.5 bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-xl hover:bg-black dark:hover:bg-gray-200 transition-all text-xs font-bold uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center gap-2",children:[f.isPending?e.jsx("i",{className:"ri-loader-4-line animate-spin"}):e.jsx("i",{className:"ri-send-plane-fill"}),e.jsx("span",{children:"Send"})]})})]})]})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full p-8",children:e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-50 dark:bg-slate-700 rounded-[2rem] flex items-center justify-center mx-auto mb-8",children:e.jsx("i",{className:"ri-chat-3-line text-4xl text-gray-200 dark:text-gray-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2 tracking-tight",children:"Communication Hub"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 font-medium leading-relaxed",children:"Select a conversation from the sidebar or start a new chat to connect with others."}),e.jsx("button",{onClick:()=>x(!0),className:"mt-6 px-6 py-3 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30",children:"Find People"})]})})})]})})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-3xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"New Message"}),e.jsx("button",{onClick:()=>x(!1),className:"w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors",children:e.jsx("i",{className:"ri-close-line text-xl dark:text-white"})})]}),e.jsx("div",{className:"p-4 border-b border-gray-100 dark:border-slate-700 bg-gray-50/50 dark:bg-slate-900/50",children:e.jsxs("div",{className:"relative",children:[e.jsx("i",{className:"ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by name...",value:w,onChange:t=>R(t.target.value),className:"w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none text-sm transition-all dark:text-white",autoFocus:!0})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:P?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx("i",{className:"ri-loader-4-line text-2xl animate-spin text-blue-600"})}):$.length===0?e.jsx("div",{className:"text-center py-10",children:e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 font-medium",children:"No users found."})}):e.jsx("div",{className:"space-y-1",children:$.map(t=>{const s=g(t.id,t.last_seen);return e.jsxs("button",{onClick:()=>J(t),className:"w-full flex items-center gap-4 p-3 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl transition-colors text-left group",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:k(t.avatar_url,80,80),alt:t.full_name,className:"w-10 h-10 rounded-full object-cover border border-gray-100 dark:border-slate-600"}),s.isOnline&&e.jsx("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors",children:t.full_name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:t.role?.replace("_"," ")})]}),e.jsx("div",{className:`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide ${s.isOnline?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300":"bg-gray-100 text-gray-500 dark:bg-slate-700 dark:text-gray-400"}`,children:s.text})]},t.id)})})})]})})]})}export{de as default};
//# sourceMappingURL=Messages-ChKnmeeJ.js.map
