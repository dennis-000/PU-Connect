{"version":3,"file":"Messages-ChKnmeeJ.js","sources":["../../src/pages/messages/Messages.tsx"],"sourcesContent":["import { useState, useEffect, useRef } from 'react';\r\nimport { useSearchParams } from 'react-router-dom';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport Navbar from '../../components/feature/Navbar';\r\nimport { getOptimizedImageUrl } from '../../lib/imageOptimization';\r\nimport { useConversations, useMessages, type Conversation } from '../../hooks/useConversations';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { logActivity } from '../../lib/logger';\r\n\r\nexport default function Messages() {\r\n  const { user } = useAuth();\r\n  const { conversations, isLoading: loadingDocs, totalUnreadCount, refetch } = useConversations();\r\n  const [selectedConversation, setSelectedConversation] = useState<Conversation | null>(null);\r\n  const { messages, isLoading: loadingMsgs, sendMessage: sendMsgMutation, markAsRead } = useMessages(selectedConversation?.id || null);\r\n\r\n  const [newMessage, setNewMessage] = useState('');\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n  const [showConversationList, setShowConversationList] = useState(true);\r\n  const [showNewChatModal, setShowNewChatModal] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [users, setUsers] = useState<any[]>([]);\r\n  const [searching, setSearching] = useState(false);\r\n\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Realtime Online Status for User List\r\n  const [onlineUsers, setOnlineUsers] = useState<Set<string>>(new Set());\r\n\r\n  useEffect(() => {\r\n    const channel = supabase.channel('online-users')\r\n      .on('presence', { event: 'sync' }, () => {\r\n        const state = channel.presenceState();\r\n        const onlineIds = new Set<string>();\r\n        for (const id in state) {\r\n          state[id].forEach((presence: any) => {\r\n            if (presence.user_id) onlineIds.add(presence.user_id);\r\n          });\r\n        }\r\n        setOnlineUsers(onlineIds);\r\n      })\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, []);\r\n\r\n  const [searchParams] = useSearchParams();\r\n  const deepLinkConversationId = searchParams.get('conversationId');\r\n\r\n  useEffect(() => {\r\n    if (deepLinkConversationId && conversations.length > 0) {\r\n      const target = conversations.find(c => c.id === deepLinkConversationId);\r\n      if (target) {\r\n        setSelectedConversation(target);\r\n      }\r\n    } else if (conversations.length > 0 && !selectedConversation && !showNewChatModal && !deepLinkConversationId) {\r\n      if (window.innerWidth >= 1024) {\r\n        setSelectedConversation(conversations[0]);\r\n      }\r\n    }\r\n  }, [conversations, selectedConversation, deepLinkConversationId, showNewChatModal]);\r\n\r\n  useEffect(() => {\r\n    if (selectedConversation && messages.length > 0) {\r\n      const unreadMessageIds = messages\r\n        .filter(m => !m.is_read && m.sender_id !== user?.id)\r\n        .map(m => m.id);\r\n\r\n      if (unreadMessageIds.length > 0) {\r\n        markAsRead.mutate(unreadMessageIds);\r\n      }\r\n    }\r\n  }, [selectedConversation, messages, user?.id, markAsRead]);\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  };\r\n\r\n  const handleConversationSelect = (conversation: Conversation) => {\r\n    setSelectedConversation(conversation);\r\n    setShowConversationList(false);\r\n  };\r\n\r\n  const handleBackToList = () => {\r\n    setShowConversationList(true);\r\n    setSelectedConversation(null);\r\n  };\r\n\r\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files && e.target.files[0]) {\r\n      const file = e.target.files[0];\r\n      if (file.size > 5 * 1024 * 1024) { // 5MB limit\r\n        alert('File size too large. Please select a file under 5MB.');\r\n        return;\r\n      }\r\n      setSelectedFile(file);\r\n    }\r\n  };\r\n\r\n  const handleRemoveFile = () => {\r\n    setSelectedFile(null);\r\n    if (fileInputRef.current) fileInputRef.current.value = '';\r\n  };\r\n\r\n  const handleSendMessage = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if ((!newMessage.trim() && !selectedFile) || !selectedConversation || !user) return;\r\n\r\n    const receiverId = selectedConversation.buyer_id === user.id\r\n      ? selectedConversation.seller_id\r\n      : selectedConversation.buyer_id;\r\n\r\n    sendMsgMutation.mutate({\r\n      message: newMessage.trim(),\r\n      receiverId,\r\n      file: selectedFile || undefined\r\n    }, {\r\n      onSuccess: async () => {\r\n        // Log Activity\r\n        try {\r\n          await logActivity(user.id, 'message_sent', {\r\n            receiver_id: receiverId,\r\n            content_snippet: newMessage.trim().slice(0, 100), // Store snippet\r\n            has_attachment: !!selectedFile\r\n          });\r\n        } catch (err) {\r\n          console.error('Failed to log message activity', err);\r\n        }\r\n\r\n        setNewMessage('');\r\n        handleRemoveFile();\r\n      }\r\n    });\r\n  };\r\n\r\n  const getOnlineStatus = (userId: string, lastSeen?: string) => {\r\n    if (onlineUsers.has(userId)) return { isOnline: true, text: 'Online' };\r\n    if (!lastSeen) return { isOnline: false, text: 'Offline' };\r\n\r\n    const lastSeenDate = new Date(lastSeen);\r\n    const now = new Date();\r\n    const diffMinutes = Math.floor((now.getTime() - lastSeenDate.getTime()) / 60000);\r\n\r\n    if (diffMinutes < 5) return { isOnline: false, text: 'Active recently' };\r\n    if (diffMinutes < 60) return { isOnline: false, text: `Active ${diffMinutes}m ago` };\r\n    if (diffMinutes < 1440) return { isOnline: false, text: `Active ${Math.floor(diffMinutes / 60)}h ago` };\r\n    return { isOnline: false, text: `Active ${Math.floor(diffMinutes / 1440)}d ago` };\r\n  };\r\n\r\n  const searchUsers = async (term: string) => {\r\n    setSearching(true);\r\n    try {\r\n      let query = supabase\r\n        .from('profiles')\r\n        .select('id, full_name, avatar_url, role, last_seen')\r\n        .neq('id', user?.id)\r\n        .limit(20);\r\n\r\n      if (term) {\r\n        query = query.ilike('full_name', `%${term}%`);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n      if (error) throw error;\r\n      setUsers(data || []);\r\n    } catch (err) {\r\n      console.error(\"Error searching users\", err);\r\n    } finally {\r\n      setSearching(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (showNewChatModal) {\r\n      searchUsers(searchTerm);\r\n    }\r\n  }, [showNewChatModal, searchTerm]);\r\n\r\n  const startNewChat = async (otherUser: any) => {\r\n    if (!user) return;\r\n\r\n    const existing = conversations.find(c =>\r\n      (c.buyer_id === user.id && c.seller_id === otherUser.id) ||\r\n      (c.seller_id === user.id && c.buyer_id === otherUser.id)\r\n    );\r\n\r\n    if (existing) {\r\n      handleConversationSelect(existing);\r\n      setShowNewChatModal(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .insert({\r\n          buyer_id: user.id,\r\n          seller_id: otherUser.id,\r\n          last_message: '',\r\n          last_message_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      await refetch();\r\n\r\n      const newConv: Conversation = {\r\n        id: data.id,\r\n        product_id: null,\r\n        buyer_id: user.id,\r\n        seller_id: otherUser.id,\r\n        created_at: data.created_at,\r\n        updated_at: data.updated_at,\r\n        product: undefined,\r\n        other_user: otherUser,\r\n        last_message: '',\r\n        last_message_at: new Date().toISOString(),\r\n        unread_count: 0\r\n      };\r\n\r\n      handleConversationSelect(newConv);\r\n      setShowNewChatModal(false);\r\n\r\n    } catch (err) {\r\n      console.error(\"Failed to start chat\", err);\r\n      alert(\"Could not start chat. Please try again.\");\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 dark:bg-slate-900 transition-colors duration-300 pb-20\">\r\n      <Navbar />\r\n\r\n      <div className=\"max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8 mt-16 pt-24\">\r\n        <div className=\"mb-4 sm:mb-6 flex justify-between items-end\">\r\n          <div>\r\n            <h1 className=\"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white tracking-tight mb-1\">Messages</h1>\r\n            <p className=\"text-sm text-gray-500 dark:text-gray-400 font-medium\">Connect with the campus community</p>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            {totalUnreadCount > 0 && (\r\n              <span className=\"bg-blue-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-blue-500/20 flex items-center h-10\">\r\n                {totalUnreadCount} New\r\n              </span>\r\n            )}\r\n            <button\r\n              onClick={() => setShowNewChatModal(true)}\r\n              className=\"bg-gray-900 dark:bg-white dark:text-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-black dark:hover:bg-gray-200 transition-all flex items-center gap-2 h-10\"\r\n            >\r\n              <i className=\"ri-edit-box-line text-lg\"></i>\r\n              <span className=\"hidden sm:inline\">New Chat</span>\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white dark:bg-slate-800 rounded-[2rem] border border-gray-100 dark:border-slate-700 shadow-xl shadow-gray-200/40 dark:shadow-none overflow-hidden h-[calc(100dvh-11rem)] md:h-[calc(100dvh-13rem)]\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-12 h-full\">\r\n            {/* Conversations List */}\r\n            <div className={`${showConversationList ? 'block' : 'hidden'} lg:block lg:col-span-4 border-r border-gray-50 dark:border-slate-700 overflow-y-auto bg-gray-50/30 dark:bg-slate-900/30`}>\r\n              {loadingDocs ? (\r\n                <div className=\"flex items-center justify-center h-full\">\r\n                  <div className=\"w-8 h-8 border-4 border-gray-100 dark:border-slate-700 border-t-blue-600 rounded-full animate-spin\"></div>\r\n                </div>\r\n              ) : conversations.length === 0 ? (\r\n                <div className=\"flex flex-col items-center justify-center h-full p-8 text-center\">\r\n                  <div className=\"w-16 h-16 bg-gray-100 dark:bg-slate-700 rounded-2xl flex items-center justify-center mb-6\">\r\n                    <i className=\"ri-message-3-line text-3xl text-gray-300 dark:text-gray-500\"></i>\r\n                  </div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900 dark:text-white mb-2 tracking-tight\">No conversations yet</h3>\r\n                  <p className=\"text-sm text-gray-500 dark:text-gray-400 font-medium mb-4\">Start chatting with students and sellers on the platform.</p>\r\n                  <button\r\n                    onClick={() => setShowNewChatModal(true)}\r\n                    className=\"text-blue-600 dark:text-blue-400 text-xs font-bold uppercase tracking-widest hover:underline\"\r\n                  >\r\n                    Start a New Chat\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <div className=\"divide-y divide-gray-50 dark:divide-slate-700\">\r\n                  {conversations.map((conversation) => {\r\n                    const otherUser = conversation.other_user;\r\n                    if (!otherUser) return null;\r\n                    const status = getOnlineStatus(otherUser.id, otherUser.last_seen);\r\n                    const hasUnread = (conversation.unread_count || 0) > 0;\r\n                    return (\r\n                      <div\r\n                        key={conversation.id}\r\n                        onClick={() => handleConversationSelect(conversation)}\r\n                        className={`p-5 transition-all cursor-pointer relative ${selectedConversation?.id === conversation.id\r\n                          ? 'bg-white dark:bg-slate-800 shadow-md border-r-4 border-r-blue-600 z-10 scale-[1.02]'\r\n                          : 'hover:bg-white dark:hover:bg-slate-800'\r\n                          } ${hasUnread ? 'bg-blue-50/20 dark:bg-blue-900/10' : ''}`}\r\n                      >\r\n                        <div className=\"flex items-start space-x-4\">\r\n                          <div className=\"relative flex-shrink-0\">\r\n                            {otherUser?.avatar_url ? (\r\n                              <img\r\n                                src={getOptimizedImageUrl(otherUser.avatar_url, 100, 80)}\r\n                                alt={otherUser.full_name}\r\n                                className=\"w-12 h-12 rounded-2xl object-cover border border-gray-100 dark:border-slate-600\"\r\n                                loading=\"lazy\"\r\n                                decoding=\"async\"\r\n                              />\r\n                            ) : (\r\n                              <div className=\"w-12 h-12 bg-gray-900 dark:bg-slate-700 rounded-2xl flex items-center justify-center\">\r\n                                <span className=\"text-white font-bold text-sm\">\r\n                                  {otherUser?.full_name?.charAt(0).toUpperCase()}\r\n                                </span>\r\n                              </div>\r\n                            )}\r\n                            {status.isOnline && (\r\n                              <div className=\"absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full\"></div>\r\n                            )}\r\n                          </div>\r\n                          <div className=\"flex-1 min-w-0\">\r\n                            <div className=\"flex items-center justify-between mb-1\">\r\n                              <h3 className={`text-sm truncate tracking-tight ${hasUnread ? 'font-bold text-gray-900 dark:text-white' : 'font-semibold text-gray-900 dark:text-white'}`}>\r\n                                {otherUser?.full_name}\r\n                              </h3>\r\n                              <span className=\"text-[10px] text-gray-400 font-bold uppercase tracking-widest whitespace-nowrap ml-2\">\r\n                                {new Date(conversation.last_message_at).toLocaleDateString([], { month: 'short', day: 'numeric' })}\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"flex items-center justify-between\">\r\n                              <p className={`text-xs truncate flex-1 font-medium ${hasUnread ? 'text-gray-900 dark:text-gray-200 font-bold' : 'text-gray-500 dark:text-gray-400'}`}>\r\n                                {conversation.last_message || 'Draft message...'}\r\n                              </p>\r\n                              {hasUnread && (\r\n                                <span className=\"ml-2 w-5 h-5 bg-blue-600 text-white text-[10px] font-bold rounded-lg flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/10\">\r\n                                  {conversation.unread_count}\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                            {conversation.product && (\r\n                              <p className=\"text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-widest mt-2 truncate\">\r\n                                Re: {conversation.product.name}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Messages Area */}\r\n            <div className={`${!showConversationList ? 'block' : 'hidden'} lg:block lg:col-span-8 flex flex-col bg-white dark:bg-slate-800`}>\r\n              {selectedConversation ? (\r\n                <>\r\n                  <div className=\"p-4 sm:p-6 border-b border-gray-50 dark:border-slate-700 flex items-center justify-between\">\r\n                    <div className=\"flex items-center space-x-4\">\r\n                      <button\r\n                        onClick={handleBackToList}\r\n                        className=\"lg:hidden w-10 h-10 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl transition-all cursor-pointer\"\r\n                      >\r\n                        <i className=\"ri-arrow-left-line text-xl text-gray-700 dark:text-gray-300\"></i>\r\n                      </button>\r\n\r\n                      <div className=\"relative\">\r\n                        {selectedConversation.other_user?.avatar_url ? (\r\n                          <img\r\n                            src={getOptimizedImageUrl(selectedConversation.other_user.avatar_url, 120, 80)}\r\n                            alt={selectedConversation.other_user.full_name}\r\n                            className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-2xl object-cover border border-gray-100 dark:border-slate-600 shadow-sm\"\r\n                            loading=\"eager\"\r\n                            decoding=\"async\"\r\n                          />\r\n                        ) : (\r\n                          <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gray-900 dark:bg-slate-700 rounded-2xl shadow-sm flex items-center justify-center\">\r\n                            <span className=\"text-white font-bold text-base\">\r\n                              {selectedConversation.other_user?.full_name?.charAt(0).toUpperCase()}\r\n                            </span>\r\n                          </div>\r\n                        )}\r\n                        {getOnlineStatus(selectedConversation.other_user?.id || '', selectedConversation.other_user?.last_seen).isOnline && (\r\n                          <div className=\"absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full\"></div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <h3 className=\"text-base sm:text-lg font-bold text-gray-900 dark:text-white truncate tracking-tight\">\r\n                          {selectedConversation.other_user?.full_name}\r\n                        </h3>\r\n                        <div className=\"flex items-center space-x-2\">\r\n                          <span className={`w-2 h-2 rounded-full ${getOnlineStatus(selectedConversation.other_user?.id || '', selectedConversation.other_user?.last_seen).isOnline ? 'bg-emerald-500' : 'bg-gray-300 dark:bg-gray-600'}`}></span>\r\n                          <p className=\"text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-widest\">\r\n                            {getOnlineStatus(selectedConversation.other_user?.id || '', selectedConversation.other_user?.last_seen).text}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {selectedConversation.product && (\r\n                      <div className=\"hidden sm:block text-right\">\r\n                        <p className=\"text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1\">Inquiry Topic</p>\r\n                        <p className=\"text-sm font-bold text-blue-600 dark:text-blue-400 truncate max-w-[150px]\">{selectedConversation.product.name}</p>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex-1 overflow-y-auto p-4 sm:p-8 space-y-6 sm:space-y-8 bg-gray-50/50 dark:bg-slate-900/50\">\r\n                    {loadingMsgs ? (\r\n                      <div className=\"flex items-center justify-center h-full\">\r\n                        <div className=\"w-8 h-8 border-4 border-gray-100 dark:border-slate-700 border-t-blue-600 rounded-full animate-spin\"></div>\r\n                      </div>\r\n                    ) : messages.map((message) => {\r\n                      const isSender = message.sender_id === user?.id;\r\n                      return (\r\n                        <div\r\n                          key={message.id}\r\n                          className={`flex ${isSender ? 'justify-end' : 'justify-start'}`}\r\n                        >\r\n                          <div\r\n                            className={`max-w-[85%] sm:max-w-md px-5 py-3 rounded-[1.5rem] shadow-sm ${isSender\r\n                              ? 'bg-blue-600 text-white rounded-tr-none'\r\n                              : 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-tl-none border border-gray-100 dark:border-slate-600'\r\n                              }`}\r\n                          >\r\n                            {message.attachment_url && (\r\n                              <div className=\"mb-3\">\r\n                                {message.attachment_type === 'image' ? (\r\n                                  <a href={message.attachment_url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                                    <img\r\n                                      src={message.attachment_url}\r\n                                      alt=\"Attachment\"\r\n                                      className=\"rounded-xl max-w-full max-h-[200px] object-cover border border-white/10\"\r\n                                      loading=\"lazy\"\r\n                                    />\r\n                                  </a>\r\n                                ) : (\r\n                                  <a\r\n                                    href={message.attachment_url}\r\n                                    target=\"_blank\"\r\n                                    rel=\"noopener noreferrer\"\r\n                                    className={`flex items-center gap-3 p-3 rounded-xl ${isSender ? 'bg-white/10' : 'bg-gray-100 dark:bg-slate-600'}`}\r\n                                  >\r\n                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${isSender ? 'bg-white/20' : 'bg-white dark:bg-slate-500'}`}>\r\n                                      <i className=\"ri-file-text-line text-xl\"></i>\r\n                                    </div>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                      <p className=\"text-xs font-bold truncate\">Attachment</p>\r\n                                      <p className=\"text-[10px] opacity-70 uppercase\">Click to view</p>\r\n                                    </div>\r\n                                    <i className=\"ri-external-link-line\"></i>\r\n                                  </a>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n                            {message.message && <p className=\"text-sm leading-relaxed whitespace-pre-wrap\">{message.message}</p>}\r\n                            <div\r\n                              className={`flex items-center justify-end mt-2 space-x-1 ${isSender ? 'text-blue-200' : 'text-gray-400'\r\n                                }`}\r\n                            >\r\n                              <span className=\"text-[10px] font-bold uppercase tracking-widest\">\r\n                                {new Date(message.created_at).toLocaleTimeString([], {\r\n                                  hour: '2-digit',\r\n                                  minute: '2-digit',\r\n                                })}\r\n                              </span>\r\n                              {isSender && (\r\n                                <i className={`ri-check-double-line ${message.is_read ? 'text-blue-200' : 'text-blue-300'}`}></i>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      );\r\n                    })}\r\n                    <div ref={messagesEndRef} />\r\n                  </div>\r\n\r\n                  <div className=\"p-4 sm:p-6 bg-white dark:bg-slate-800 border-t border-gray-50 dark:border-slate-700\">\r\n                    {selectedFile && (\r\n                      <div className=\"mb-4 flex items-center gap-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-2xl border border-gray-100 dark:border-slate-600 animate-fade-in-up\">\r\n                        <div className=\"w-12 h-12 rounded-xl bg-white dark:bg-slate-600 border border-gray-200 dark:border-slate-500 flex items-center justify-center overflow-hidden\">\r\n                          {selectedFile.type.startsWith('image/') ? (\r\n                            <img\r\n                              src={URL.createObjectURL(selectedFile)}\r\n                              alt=\"Preview\"\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <i className=\"ri-file-text-line text-2xl text-gray-400 dark:text-gray-300\"></i>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <p className=\"text-xs font-bold text-gray-900 dark:text-white truncate\">{selectedFile.name}</p>\r\n                          <p className=\"text-[10px] text-gray-500 dark:text-gray-400 font-medium\">\r\n                            {(selectedFile.size / 1024 / 1024).toFixed(2)} MB\r\n                          </p>\r\n                        </div>\r\n                        <button\r\n                          onClick={handleRemoveFile}\r\n                          className=\"w-8 h-8 rounded-full bg-gray-200 dark:bg-slate-600 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-colors\"\r\n                        >\r\n                          <i className=\"ri-close-line\"></i>\r\n                        </button>\r\n                      </div>\r\n                    )}\r\n\r\n                    <form onSubmit={handleSendMessage} className=\"relative flex items-end gap-3\">\r\n                      <input\r\n                        type=\"file\"\r\n                        ref={fileInputRef}\r\n                        onChange={handleFileSelect}\r\n                        className=\"hidden\"\r\n                        accept=\"image/*,.pdf,.doc,.docx\"\r\n                      />\r\n\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => fileInputRef.current?.click()}\r\n                        className=\"w-12 h-14 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 text-gray-500 dark:text-gray-300 hover:text-blue-600 rounded-2xl flex items-center justify-center transition-colors border border-transparent hover:border-gray-200 dark:hover:border-slate-500 flex-shrink-0\"\r\n                        title=\"Attach file\"\r\n                      >\r\n                        <i className=\"ri-attachment-2 text-xl\"></i>\r\n                      </button>\r\n\r\n                      <div className=\"relative flex-1\">\r\n                        <input\r\n                          type=\"text\"\r\n                          value={newMessage}\r\n                          onChange={(e) => setNewMessage(e.target.value)}\r\n                          placeholder=\"Compose your message...\"\r\n                          className=\"w-full pl-6 pr-32 py-4 bg-gray-50 dark:bg-slate-700 border-none rounded-2xl focus:ring-2 focus:ring-blue-600 dark:text-white text-sm font-medium transition-all\"\r\n                          disabled={sendMsgMutation.isPending}\r\n                        />\r\n                        <div className=\"absolute right-2 top-1/2 -translate-y-1/2 flex items-center space-x-2\">\r\n                          <button\r\n                            type=\"submit\"\r\n                            disabled={sendMsgMutation.isPending || (!newMessage.trim() && !selectedFile)}\r\n                            className=\"px-6 py-2.5 bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-xl hover:bg-black dark:hover:bg-gray-200 transition-all text-xs font-bold uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center gap-2\"\r\n                          >\r\n                            {sendMsgMutation.isPending ? (\r\n                              <i className=\"ri-loader-4-line animate-spin\"></i>\r\n                            ) : (\r\n                              <i className=\"ri-send-plane-fill\"></i>\r\n                            )}\r\n                            <span>Send</span>\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    </form>\r\n                  </div>\r\n                </>\r\n              ) : (\r\n                <div className=\"flex items-center justify-center h-full p-8\">\r\n                  <div className=\"text-center max-w-sm\">\r\n                    <div className=\"w-20 h-20 bg-gray-50 dark:bg-slate-700 rounded-[2rem] flex items-center justify-center mx-auto mb-8\">\r\n                      <i className=\"ri-chat-3-line text-4xl text-gray-200 dark:text-gray-500\"></i>\r\n                    </div>\r\n                    <h3 className=\"text-2xl font-bold text-gray-900 dark:text-white mb-2 tracking-tight\">Communication Hub</h3>\r\n                    <p className=\"text-sm text-gray-500 dark:text-gray-400 font-medium leading-relaxed\">Select a conversation from the sidebar or start a new chat to connect with others.</p>\r\n                    <button\r\n                      onClick={() => setShowNewChatModal(true)}\r\n                      className=\"mt-6 px-6 py-3 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30\"\r\n                    >\r\n                      Find People\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* New Chat Modal */}\r\n      {showNewChatModal && (\r\n        <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n          <div className=\"bg-white dark:bg-slate-800 rounded-3xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95 duration-200\">\r\n            <div className=\"p-6 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between\">\r\n              <h3 className=\"text-xl font-bold text-gray-900 dark:text-white\">New Message</h3>\r\n              <button\r\n                onClick={() => setShowNewChatModal(false)}\r\n                className=\"w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors\"\r\n              >\r\n                <i className=\"ri-close-line text-xl dark:text-white\"></i>\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"p-4 border-b border-gray-100 dark:border-slate-700 bg-gray-50/50 dark:bg-slate-900/50\">\r\n              <div className=\"relative\">\r\n                <i className=\"ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-gray-400\"></i>\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Search by name...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none text-sm transition-all dark:text-white\"\r\n                  autoFocus\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto p-2\">\r\n              {searching ? (\r\n                <div className=\"flex items-center justify-center py-10\">\r\n                  <i className=\"ri-loader-4-line text-2xl animate-spin text-blue-600\"></i>\r\n                </div>\r\n              ) : users.length === 0 ? (\r\n                <div className=\"text-center py-10\">\r\n                  <p className=\"text-sm text-gray-500 dark:text-gray-400 font-medium\">No users found.</p>\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-1\">\r\n                  {users.map(u => {\r\n                    const status = getOnlineStatus(u.id, u.last_seen);\r\n                    return (\r\n                      <button\r\n                        key={u.id}\r\n                        onClick={() => startNewChat(u)}\r\n                        className=\"w-full flex items-center gap-4 p-3 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl transition-colors text-left group\"\r\n                      >\r\n                        <div className=\"relative\">\r\n                          <img\r\n                            src={getOptimizedImageUrl(u.avatar_url, 80, 80)}\r\n                            alt={u.full_name}\r\n                            className=\"w-10 h-10 rounded-full object-cover border border-gray-100 dark:border-slate-600\"\r\n                          />\r\n                          {status.isOnline && (\r\n                            <div className=\"absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-white dark:border-slate-800 rounded-full\"></div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <h4 className=\"text-sm font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\">{u.full_name}</h4>\r\n                          <p className=\"text-xs text-gray-500 dark:text-gray-400 truncate\">{u.role?.replace('_', ' ')}</p>\r\n                        </div>\r\n                        <div className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide ${status.isOnline ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300' : 'bg-gray-100 text-gray-500 dark:bg-slate-700 dark:text-gray-400'\r\n                          }`}>\r\n                          {status.text}\r\n                        </div>\r\n                      </button>\r\n                    )\r\n                  })}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":["Messages","user","useAuth","conversations","loadingDocs","totalUnreadCount","refetch","useConversations","selectedConversation","setSelectedConversation","useState","messages","loadingMsgs","sendMsgMutation","markAsRead","useMessages","newMessage","setNewMessage","selectedFile","setSelectedFile","showConversationList","setShowConversationList","showNewChatModal","setShowNewChatModal","searchTerm","setSearchTerm","users","setUsers","searching","setSearching","messagesEndRef","useRef","fileInputRef","onlineUsers","setOnlineUsers","useEffect","channel","supabase","state","onlineIds","id","presence","searchParams","useSearchParams","deepLinkConversationId","target","c","unreadMessageIds","m","scrollToBottom","handleConversationSelect","conversation","handleBackToList","handleFileSelect","e","file","handleRemoveFile","handleSendMessage","receiverId","logActivity","err","getOnlineStatus","userId","lastSeen","lastSeenDate","diffMinutes","searchUsers","term","query","data","error","startNewChat","otherUser","existing","newConv","jsxs","jsx","Navbar","status","hasUnread","getOptimizedImageUrl","Fragment","message","isSender","u"],"mappings":"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"}