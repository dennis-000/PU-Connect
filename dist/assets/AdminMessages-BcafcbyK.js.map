{"version":3,"mappings":"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","names":["AdminMessages","profile","user","useAuth","navigate","useNavigate","conversations","loadingDocs","useConversations","selectedConversation","setSelectedConversation","useState","messages","loadingMsgs","sendMsgMutation","markAsRead","useMessages","newMessage","setNewMessage","messagesEndRef","useRef","showNewChatModal","setShowNewChatModal","recipients","setRecipients","useEffect","data","__vitePreload","supabase","n","unreadMessageIds","m","handleSendMessage","e","receiverId","startNewChat","recipient","existing","c","error","profileError","retryData","retryError","err","jsxs","jsx","Navbar","conversation","otherUser","hasUnread","getOptimizedImageUrl","Fragment","message","isSender"],"ignoreList":[],"sources":["../../src/pages/admin/AdminMessages.tsx"],"sourcesContent":["import { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport Navbar from '../../components/feature/Navbar';\r\nimport { useConversations, useMessages, type Conversation } from '../../hooks/useConversations';\r\nimport { getOptimizedImageUrl } from '../../lib/imageOptimization';\r\n\r\nexport default function AdminMessages() {\r\n  const { profile, user } = useAuth();\r\n  const navigate = useNavigate();\r\n\r\n  // Real-time hooks\r\n  const { conversations, isLoading: loadingDocs } = useConversations();\r\n  const [selectedConversation, setSelectedConversation] = useState<Conversation | null>(null);\r\n  const { messages, isLoading: loadingMsgs, sendMessage: sendMsgMutation, markAsRead } = useMessages(selectedConversation?.id || null);\r\n\r\n  const [newMessage, setNewMessage] = useState('');\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n  // New Chat State\r\n  const [showNewChatModal, setShowNewChatModal] = useState(false);\r\n  const [recipients, setRecipients] = useState<any[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (profile?.role !== 'admin' && profile?.role !== 'super_admin' && profile?.role !== 'news_publisher') {\r\n      // Allow access to all staff roles for now, or restrict as needed\r\n      // navigate('/marketplace');\r\n    }\r\n  }, [profile, navigate]);\r\n\r\n  // Fetch Potential Recipients for New Chat\r\n  useEffect(() => {\r\n    if (showNewChatModal) {\r\n      const fetchRecipients = async () => {\r\n        const { data } = await import('../../lib/supabase').then(({ supabase }) =>\r\n          supabase.from('profiles')\r\n            .select('id, full_name, role, avatar_url')\r\n            .in('role', ['admin', 'super_admin', 'news_publisher'])\r\n            .neq('id', user?.id)\r\n        );\r\n        if (data) setRecipients(data);\r\n      };\r\n      fetchRecipients();\r\n    }\r\n  }, [showNewChatModal, user?.id]);\r\n\r\n  // Handle Mark as Read\r\n  useEffect(() => {\r\n    if (selectedConversation && messages.length > 0) {\r\n      const unreadMessageIds = messages\r\n        .filter(m => !m.is_read && m.sender_id !== user?.id)\r\n        .map(m => m.id);\r\n\r\n      if (unreadMessageIds.length > 0) {\r\n        markAsRead.mutate(unreadMessageIds);\r\n      }\r\n    }\r\n  }, [selectedConversation, messages, user?.id, markAsRead]);\r\n\r\n  // Auto-scroll to bottom\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n\r\n  const handleSendMessage = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!newMessage.trim() || !selectedConversation || !user) return;\r\n\r\n    // Determine receiver (the other person in the conversation)\r\n    const receiverId = selectedConversation.buyer_id === user.id\r\n      ? selectedConversation.seller_id\r\n      : selectedConversation.buyer_id;\r\n\r\n    sendMsgMutation.mutate({\r\n      message: newMessage.trim(),\r\n      receiverId\r\n    }, {\r\n      onSuccess: () => {\r\n        setNewMessage('');\r\n      }\r\n    });\r\n  };\r\n\r\n  const startNewChat = async (recipient: any) => {\r\n    // Check if conversation exists (client-side check for now)\r\n    const existing = conversations.find(c =>\r\n      c.buyer_id === recipient.id || c.seller_id === recipient.id\r\n    );\r\n\r\n    if (existing) {\r\n      setSelectedConversation(existing);\r\n      setShowNewChatModal(false);\r\n    } else {\r\n      // Create conversation immediately\r\n      const { supabase } = await import('../../lib/supabase');\r\n\r\n      try {\r\n        const { data, error } = await supabase.from('conversations').insert({\r\n          buyer_id: user?.id,\r\n          seller_id: recipient.id,\r\n        }).select().single();\r\n\r\n        if (error) {\r\n          // Handle missing profile error (foreign key violation)\r\n          if (error.code === '23503') {\r\n            // Create missing profile for admin\r\n            const { error: profileError } = await supabase.from('profiles').upsert({\r\n              id: user?.id,\r\n              email: user?.email,\r\n              full_name: 'Admin User', // Fallback name\r\n              role: 'admin',\r\n              created_at: new Date().toISOString()\r\n            });\r\n\r\n            if (!profileError) {\r\n              // Retry conversation creation\r\n              const { data: retryData, error: retryError } = await supabase.from('conversations').insert({\r\n                buyer_id: user?.id,\r\n                seller_id: recipient.id,\r\n              }).select().single();\r\n\r\n              if (retryData) {\r\n                // @ts-ignore\r\n                setSelectedConversation(retryData);\r\n                window.location.reload();\r\n              } else if (retryError) {\r\n                throw retryError;\r\n              }\r\n            } else {\r\n              throw profileError;\r\n            }\r\n          } else {\r\n            throw error;\r\n          }\r\n        } else if (data) {\r\n          // @ts-ignore\r\n          setSelectedConversation(data);\r\n          window.location.reload();\r\n        }\r\n      } catch (err) {\r\n        console.error('Failed to start chat:', err);\r\n        alert('Failed to start conversation. Please try again.');\r\n      }\r\n      setShowNewChatModal(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50/50 dark:bg-gray-950 transition-colors duration-300\">\r\n      <Navbar />\r\n\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-12 pt-28 pb-10 md:pt-32 md:pb-16\">\r\n        <div className=\"flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8\">\r\n          <div>\r\n            <div className=\"inline-flex items-center gap-2 px-4 py-1.5 bg-gray-900 dark:bg-blue-600 text-white text-[10px] font-bold uppercase tracking-wide rounded-full mb-6 shadow-lg shadow-gray-200/20 dark:shadow-blue-900/40\">\r\n              <i className=\"ri-team-line text-blue-400 dark:text-white\"></i>\r\n              Internal Comms\r\n            </div>\r\n            <h1 className=\"text-4xl md:text-5xl font-bold text-gray-900 dark:text-white tracking-tight leading-tight\">\r\n              Team<br /><span className=\"text-blue-600 dark:text-blue-400\">Chat.</span>\r\n            </h1>\r\n          </div>\r\n          <button\r\n            onClick={() => setShowNewChatModal(true)}\r\n            className=\"px-6 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2\"\r\n          >\r\n            <i className=\"ri-add-line text-lg\"></i>\r\n            New Chat\r\n          </button>\r\n        </div>\r\n\r\n        <div className=\"bg-white dark:bg-gray-900 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-xl shadow-gray-200/40 dark:shadow-none overflow-hidden transition-colors duration-300\" style={{ height: 'calc(100vh - 350px)' }}>\r\n          <div className=\"grid grid-cols-12 h-full\">\r\n            {/* Conversations List */}\r\n            <div className=\"col-span-12 md:col-span-4 border-r border-gray-50 dark:border-gray-800 overflow-y-auto\">\r\n              {loadingDocs ? (\r\n                <div className=\"flex items-center justify-center h-full\">\r\n                  <div className=\"w-10 h-10 border-4 border-gray-100 dark:border-gray-800 border-t-blue-600 rounded-full animate-spin\"></div>\r\n                </div>\r\n              ) : conversations.length === 0 ? (\r\n                <div className=\"flex flex-col items-center justify-center h-full p-10 text-center\">\r\n                  <div className=\"w-16 h-16 bg-gray-50 dark:bg-gray-800 rounded-2xl flex items-center justify-center mb-6\">\r\n                    <i className=\"ri-message-3-line text-3xl text-gray-400 dark:text-gray-500\"></i>\r\n                  </div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900 dark:text-white tracking-tight mb-2\">No active chats</h3>\r\n                  <p className=\"text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wide leading-relaxed\">Start a conversation to see it here</p>\r\n                </div>\r\n              ) : (\r\n                <div className=\"divide-y divide-gray-50 dark:divide-gray-800\">\r\n                  {conversations.map((conversation) => {\r\n                    const otherUser = conversation.other_user;\r\n                    const hasUnread = (conversation.unread_count || 0) > 0;\r\n\r\n                    return (\r\n                      <div\r\n                        key={conversation.id}\r\n                        onClick={() => setSelectedConversation(conversation)}\r\n                        className={`p-6 hover:bg-gray-50/50 dark:hover:bg-gray-800/50 cursor-pointer transition-all relative ${selectedConversation?.id === conversation.id ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''\r\n                          }`}\r\n                      >\r\n                        {selectedConversation?.id === conversation.id && (\r\n                          <div className=\"absolute left-0 top-0 bottom-0 w-1 bg-blue-600\"></div>\r\n                        )}\r\n\r\n                        <div className=\"flex items-center gap-3 mb-2\">\r\n                          <div className=\"relative flex-shrink-0\">\r\n                            {otherUser?.avatar_url ? (\r\n                              <img\r\n                                src={getOptimizedImageUrl(otherUser.avatar_url, 40, 40)}\r\n                                alt={otherUser.full_name}\r\n                                className=\"w-10 h-10 rounded-xl object-cover border border-gray-100 dark:border-gray-700\"\r\n                              />\r\n                            ) : (\r\n                              <div className=\"w-10 h-10 bg-gray-900 dark:bg-gray-700 rounded-xl flex items-center justify-center text-white font-bold text-xs\">\r\n                                {otherUser?.full_name?.charAt(0).toUpperCase()}\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                          <div className=\"overflow-hidden\">\r\n                            <h3 className={`text-[11px] uppercase tracking-wider truncate ${hasUnread ? 'font-black text-gray-900 dark:text-white' : 'font-bold text-gray-700 dark:text-gray-300'}`}>\r\n                              {otherUser?.full_name}\r\n                            </h3>\r\n                            <p className={`text-xs truncate leading-relaxed ${hasUnread ? 'font-bold text-gray-900 dark:text-white' : 'font-semibold text-gray-500 dark:text-gray-500'}`}>\r\n                              {conversation.last_message || 'Attachment'}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center justify-between ml-13 pl-1\">\r\n                          <span className=\"text-[9px] font-bold text-gray-400 dark:text-gray-600 tabular-nums uppercase tracking-wide\">\r\n                            {new Date(conversation.last_message_at).toLocaleDateString()}\r\n                          </span>\r\n                          {hasUnread && (\r\n                            <span className=\"px-1.5 py-0.5 bg-blue-600 text-white text-[9px] font-bold rounded-md shadow-sm\">\r\n                              {conversation.unread_count} new\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Messages Area */}\r\n            <div className=\"col-span-12 md:col-span-8 flex flex-col bg-gray-50/20 dark:bg-black/20\">\r\n              {selectedConversation ? (\r\n                <>\r\n                  {/* Chat Header */}\r\n                  <div className=\"p-6 border-b border-gray-50 dark:border-gray-800 bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                        {selectedConversation.other_user?.avatar_url ? (\r\n                          <img\r\n                            src={getOptimizedImageUrl(selectedConversation.other_user.avatar_url, 50, 50)}\r\n                            className=\"w-12 h-12 rounded-2xl object-cover shadow-sm dark:shadow-none border border-gray-100 dark:border-gray-800\"\r\n                          />\r\n                        ) : (\r\n                          <div className=\"w-12 h-12 bg-gray-900 dark:bg-gray-800 rounded-2xl flex items-center justify-center text-white font-bold\">\r\n                            {selectedConversation.other_user?.full_name?.charAt(0)}\r\n                          </div>\r\n                        )}\r\n                        <div>\r\n                          <h3 className=\"text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wide mb-1 leading-none\">Chatting With</h3>\r\n                          <p className=\"text-lg font-bold text-gray-900 dark:text-white tracking-tight\">\r\n                            {selectedConversation.other_user?.full_name}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                      {selectedConversation.product && (\r\n                        <div className=\"text-right hidden md:block\">\r\n                          <p className=\"text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wide mb-1 leading-none\">Context</p>\r\n                          <p className=\"text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-tight\">{selectedConversation.product.name}</p>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Messages */}\r\n                  <div className=\"flex-1 overflow-y-auto p-8 space-y-6\">\r\n                    {loadingMsgs ? (\r\n                      <div className=\"flex items-center justify-center h-full\">\r\n                        <div className=\"w-8 h-8 border-4 border-gray-200 dark:border-gray-800 border-t-blue-600 rounded-full animate-spin\"></div>\r\n                      </div>\r\n                    ) : messages.length === 0 ? (\r\n                      <div className=\"flex items-center justify-center h-full\">\r\n                        <p className=\"text-[10px] font-bold text-gray-400 dark:text-gray-600 uppercase tracking-wide\">No messages yet. Say hello!</p>\r\n                      </div>\r\n                    ) : (\r\n                      messages.map((message) => {\r\n                        const isSender = message.sender_id === user?.id;\r\n                        return (\r\n                          <div key={message.id} className={`flex flex-col ${isSender ? 'items-end' : 'items-start'}`}>\r\n                            <div className={`flex items-end gap-2 max-w-[80%] ${isSender ? 'flex-row-reverse' : 'flex-row'}`}>\r\n                              {!isSender && (\r\n                                <div className=\"w-6 h-6 bg-gray-200 dark:bg-gray-800 rounded-lg flex-shrink-0 flex items-center justify-center text-[10px] font-bold text-gray-500 dark:text-gray-400\">\r\n                                  {message.sender?.full_name?.[0]}\r\n                                </div>\r\n                              )}\r\n\r\n                              <div className={`px-5 py-3 rounded-2xl shadow-sm border text-sm font-medium leading-relaxed ${isSender\r\n                                ? 'bg-gray-900 dark:bg-blue-600 text-white border-transparent rounded-tr-none'\r\n                                : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border-gray-100 dark:border-gray-700 rounded-tl-none conversation-bubble'\r\n                                }`}>\r\n                                {message.message}\r\n                              </div>\r\n                            </div>\r\n\r\n                            <span className=\"text-[9px] font-bold text-gray-400 dark:text-gray-600 uppercase tracking-wide mt-1 mx-9\">\r\n                              {new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                            </span>\r\n                          </div>\r\n                        )\r\n                      })\r\n                    )}\r\n                    <div ref={messagesEndRef} />\r\n                  </div>\r\n\r\n                  {/* Input Area */}\r\n                  <div className=\"p-4 bg-white dark:bg-gray-900 border-t border-gray-50 dark:border-gray-800\">\r\n                    <form onSubmit={handleSendMessage} className=\"relative\">\r\n                      <input\r\n                        type=\"text\"\r\n                        value={newMessage}\r\n                        onChange={(e) => setNewMessage(e.target.value)}\r\n                        placeholder=\"Type your message...\"\r\n                        className=\"w-full pl-6 pr-32 py-4 bg-gray-50 dark:bg-gray-800 border-none rounded-2xl focus:ring-2 focus:ring-blue-600/20 focus:bg-white dark:focus:bg-gray-800 text-sm font-medium text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 transition-all\"\r\n                        disabled={sendMsgMutation.isPending}\r\n                      />\r\n                      <div className=\"absolute right-2 top-1/2 -translate-y-1/2\">\r\n                        <button\r\n                          type=\"submit\"\r\n                          disabled={sendMsgMutation.isPending || !newMessage.trim()}\r\n                          className=\"px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all text-xs font-bold uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center gap-2 shadow-lg shadow-blue-200 dark:shadow-none\"\r\n                        >\r\n                          {sendMsgMutation.isPending ? (\r\n                            <i className=\"ri-loader-4-line animate-spin\"></i>\r\n                          ) : (\r\n                            <i className=\"ri-send-plane-fill\"></i>\r\n                          )}\r\n                          <span>Send</span>\r\n                        </button>\r\n                      </div>\r\n                    </form>\r\n                  </div>\r\n                </>\r\n              ) : (\r\n                <div className=\"flex items-center justify-center h-full\">\r\n                  <div className=\"text-center\">\r\n                    <div className=\"w-16 h-16 bg-white dark:bg-gray-800 rounded-[1.5rem] shadow-sm border border-gray-100 dark:border-gray-800 flex items-center justify-center mx-auto mb-6\">\r\n                      <i className=\"ri-chat-smile-2-line text-3xl text-gray-300 dark:text-gray-600\"></i>\r\n                    </div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900 dark:text-white tracking-tight mb-2\">Select a Conversation</h3>\r\n                    <p className=\"text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wide\">Choose a colleague from the list to start chatting</p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* New Chat Modal */}\r\n      {showNewChatModal && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in\">\r\n          <div className=\"bg-white dark:bg-gray-900 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-gray-100 dark:border-gray-800\">\r\n            <div className=\"p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center\">\r\n              <h3 className=\"font-bold text-lg dark:text-white\">New Message</h3>\r\n              <button onClick={() => setShowNewChatModal(false)} className=\"w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center transition-colors\">\r\n                <i className=\"ri-close-line text-xl\"></i>\r\n              </button>\r\n            </div>\r\n            <div className=\"max-h-[60vh] overflow-y-auto p-4 space-y-2\">\r\n              {recipients.map(r => (\r\n                <div key={r.id} onClick={() => startNewChat(r)} className=\"flex items-center gap-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl cursor-pointer transition-colors\">\r\n                  <div className=\"w-10 h-10 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center font-bold\">\r\n                    {r.full_name[0]}\r\n                  </div>\r\n                  <div>\r\n                    <h4 className=\"font-bold text-sm dark:text-white\">{r.full_name}</h4>\r\n                    <p className=\"text-xs text-gray-500 uppercase\">{r.role.replace('_', ' ')}</p>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n              {recipients.length === 0 && <p className=\"text-center text-gray-500 py-4\">No other admins found.</p>}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"file":"AdminMessages-BcafcbyK.js"}